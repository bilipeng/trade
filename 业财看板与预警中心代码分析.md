# 业财看板与预警中心代码分析

## 概述

您的系统中，业财看板和预警中心的实现分为前端和后端两部分。前端使用PyQt6实现用户界面，后端使用Flask提供API服务。

## 前端实现

### 1. 业财看板 (DashboardWidget)

**文件位置**: `client/views/dashboard.py`

**主要功能**:
- 显示项目统计信息（总项目数、总预算、已完成项目、进行中项目）
- 显示项目进度对比表格
- 显示预算执行情况表格

**关键组件**:
- `DashboardWidget`: 业财看板主界面
- `loadData()`: 加载数据方法
- `updateProgressTable()`: 更新进度表格
- `updateBudgetTable()`: 更新预算表格

**数据来源**:
目前使用的是硬编码的模拟数据，而不是从API获取：
```python
# 加载项目进度数据
progress_data = {
    "names": ["项目A", "项目B", "项目C", "项目D", "项目E"],
    "planned_progress": [100, 80, 60, 40, 20],
    "actual_progress": [95, 70, 65, 30, 25]
}

# 加载预算执行数据
budget_data = {
    "names": ["项目A", "项目B", "项目C", "项目D", "项目E"],
    "budget": [500000, 300000, 200000, 150000, 100000],
    "spent": [480000, 250000, 180000, 100000, 90000]
}
```

### 2. 预警中心 (AlertCenterWidget)

**文件位置**: `client/views/alert_center.py`

**主要功能**:
- 资金池监控（总资金使用情况、部门资金使用情况）
- 预警规则管理（添加、编辑、删除规则）
- 预警记录管理（查看、处理、忽略预警）

**关键组件**:
- `FundPoolWidget`: 资金池监控组件
- `AlertRuleDialog`: 预警规则配置对话框
- `AlertCenterWidget`: 预警中心主界面
- `loadData()`: 加载数据方法
- `updateRulesTable()`: 更新规则表格
- `updateAlertsTable()`: 更新预警记录表格

**数据来源**:
同样使用的是硬编码的模拟数据：
```python
# 资金池数据
fund_pool_data = {
    'total_funds': {
        'total': 10000000,
        'used': 6000000,
        'reserved': 1000000,
        'available': 3000000
    },
    'department_funds': [
        {
            'name': '研发部',
            'total': 3000000,
            'used': 2000000,
            'reserved': 500000,
            'available': 500000
        },
        # 其他部门...
    ]
}

# 预警规则数据
rules = [
    {
        'id': 1,
        'name': '资金使用率预警',
        'indicator': '资金使用率',
        'condition': '大于',
        'threshold': 80,
        'severity': '高',
        'is_active': True
    },
    # 其他规则...
]

# 预警记录数据
alerts = [
    {
        'id': 1,
        'time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
        'rule_name': '资金使用率预警',
        'target': '研发部',
        'current_value': 85,
        'status': '未处理'
    },
    # 其他预警...
]
```

## 后端实现

**文件位置**: `server/app_fixed.py`

### 1. 业财看板API

```python
# 业财看板API
@app.route('/api/dashboard/business-finance', methods=['GET'])
@token_required
def get_business_finance():
    # 模拟数据
    return jsonify({
        'revenue': 1000000,
        'expenses': 800000,
        'profit': 200000,
        'growth_rate': 15.5
    })
```

### 2. 预警中心API

```python
# 项目统计
@app.route('/api/projects/stats', methods=['GET'])
@token_required
def get_project_stats():
    """获取项目统计数据"""
    # 模拟数据
    return jsonify({
        "total_projects": 12,
        "total_budget": 1500000.00,
        "completed_projects": 5,
        "in_progress_projects": 7
    })

# 预警统计
@app.route('/api/alerts/stats', methods=['GET'])
@token_required
def get_alert_stats():
    """获取预警统计数据"""
    # 模拟数据
    return jsonify({
        "total_alerts": 8,
        "unhandled_alerts": 3,
        "high_priority_alerts": 2,
        "medium_priority_alerts": 4,
        "low_priority_alerts": 2
    })

# 项目进度
@app.route('/api/projects/progress', methods=['GET'])
@token_required
def get_project_progress():
    """获取项目进度数据"""
    # 模拟数据
    return jsonify({
        "names": ["项目A", "项目B", "项目C", "项目D", "项目E"],
        "planned_progress": [100, 80, 60, 40, 20],
        "actual_progress": [95, 70, 65, 30, 25]
    })

# 项目预算
@app.route('/api/projects/budget', methods=['GET'])
@token_required
def get_project_budget():
    """获取项目预算数据"""
    # 模拟数据
    return jsonify({
        "names": ["项目A", "项目B", "项目C", "项目D", "项目E"],
        "budget": [500000, 300000, 200000, 150000, 100000],
        "spent": [480000, 250000, 180000, 100000, 90000]
    })

# 预警规则
@app.route('/api/alert-rules', methods=['GET', 'POST', 'DELETE'])
@token_required
def alert_rules():
    if request.method == 'GET':
        # 获取预警规则列表
        return jsonify([
            {'id': 1, 'name': '收入异常预警', 'condition': 'revenue < 1000000'},
            {'id': 2, 'name': '支出异常预警', 'condition': 'expenses > 1000000'}
        ])
    elif request.method == 'POST':
        # 创建新预警规则
        data = request.json
        return jsonify({'message': '预警规则创建成功', 'rule_id': 3})
    elif request.method == 'DELETE':
        # 删除预警规则
        rule_id = request.args.get('id')
        return jsonify({'message': f'预警规则 {rule_id} 删除成功'})

# 预警记录
@app.route('/api/alerts', methods=['GET', 'POST'])
@token_required
def alerts():
    if request.method == 'GET':
        # 获取预警列表
        return jsonify([
            {'id': 1, 'rule_id': 1, 'message': '收入低于预期', 'status': 'active'},
            {'id': 2, 'rule_id': 2, 'message': '支出超出预算', 'status': 'handled'}
        ])
    elif request.method == 'POST':
        # 处理预警
        data = request.json
        return jsonify({'message': '预警处理成功'})
```

## 数据库设计

目前系统中没有看到与业财看板和预警中心相关的数据库表定义。后端API都使用的是硬编码的模拟数据，而不是从数据库中查询。

要实现完整的业财看板和预警中心功能，需要设计以下数据库表：

1. **资金池表(fund_pools)**
   - id: 主键
   - name: 资金池名称
   - parent_id: 父资金池ID（用于层级结构）
   - total_amount: 总金额
   - used_amount: 已使用金额
   - reserved_amount: 已预留金额
   - alert_threshold: 预警阈值
   - created_at: 创建时间
   - updated_at: 更新时间

2. **预警规则表(alert_rules)**
   - id: 主键
   - name: 规则名称
   - description: 规则描述
   - indicator: 监控指标
   - condition: 条件
   - threshold: 阈值
   - severity: 严重程度
   - notify_roles: 通知角色
   - is_active: 是否启用
   - created_at: 创建时间
   - updated_at: 更新时间

3. **预警记录表(alerts)**
   - id: 主键
   - rule_id: 规则ID
   - target_id: 目标ID
   - target_type: 目标类型
   - current_value: 当前值
   - status: 状态
   - handled_by: 处理人
   - handled_at: 处理时间
   - created_at: 创建时间
   - updated_at: 更新时间

## 总结

您的系统中已经有了业财看板和预警中心的基本框架，包括前端界面和后端API。但目前都使用的是硬编码的模拟数据，而不是从数据库中查询实际数据。

要完成实际功能，需要：

1. **创建数据库表**：设计并创建资金池、预警规则、预警记录等相关表

2. **实现后端API**：修改后端API，从数据库中查询实际数据，而不是返回模拟数据

3. **连接前后端**：修改前端代码，通过API从后端获取数据，而不是使用硬编码的模拟数据

4. **实现业务逻辑**：
   - 资金使用监控
   - 预警规则检查
   - 预警生成和通知
   - 预警处理流程
