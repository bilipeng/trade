# 业财看板和预警中心功能集成指南

本文档详细说明了在将`dashboard.py`、`alert_center.py`和`app_fixed.py`文件放置到正确位置后，需要进行的代码修改，以完全集成业财看板和预警中心功能。

## 1. 修改主窗口文件 (main_window.py)

主窗口文件需要修改以导入和集成新的视图组件。

### 1.1 添加导入语句

在`main_window.py`文件顶部的导入部分添加以下代码：

```python
# 导入新的视图组件
from views.dashboard import DashboardView
from views.alert_center import AlertCenterView
```

### 1.2 修改init_ui方法

在`init_ui`方法中，找到添加内容页面到选项卡的部分（大约在第285行附近），添加以下代码：

```python
# 添加业财看板和预警中心视图
if self.user_data['role'] in ['管理员', '财务人员']:
    self.dashboard_view = DashboardView(self)
    self.content_tabs.addTab(self.dashboard_view, "业财看板")
    
    self.alert_center_view = AlertCenterView(self)
    self.content_tabs.addTab(self.alert_center_view, "预警中心")
```

### 1.3 添加导航按钮

在创建导航按钮的部分（大约在第190行附近），添加以下代码：

```python
# 添加业财看板和预警中心导航按钮
if self.user_data['role'] in ['管理员', '财务人员']:
    self.create_nav_button("业财看板", "📊", "查看业财融合数据看板", nav_layout, 4)
    self.create_nav_button("预警中心", "⚠️", "查看业务财务预警信息", nav_layout, 5)
```

### 1.4 修改change_page方法

在`change_page`方法中（大约在第364行附近），添加以下代码：

```python
# 处理业财看板和预警中心页面切换
elif index == 4 and hasattr(self, 'dashboard_view'):
    self.content_tabs.setCurrentWidget(self.dashboard_view)
elif index == 5 and hasattr(self, 'alert_center_view'):
    self.content_tabs.setCurrentWidget(self.alert_center_view)
```

### 1.5 修改on_tab_changed方法

在`on_tab_changed`方法中（大约在第387行附近），添加以下代码：

```python
# 处理业财看板和预警中心选项卡切换
elif tab_title == "业财看板":
    nav_button = self.findChild(QPushButton, "nav_业财看板")
    if nav_button:
        self.change_page(4, nav_button, "业财看板")
elif tab_title == "预警中心":
    nav_button = self.findChild(QPushButton, "nav_预警中心")
    if nav_button:
        self.change_page(5, nav_button, "预警中心")
```

### 1.6 添加切换方法（可选）

为了方便从其他地方直接切换到这些视图，可以添加以下方法：

```python
def switch_to_dashboard_view(self):
    """切换到业财看板视图"""
    if hasattr(self, "dashboard_view"):
        self.content_tabs.setCurrentWidget(self.dashboard_view)
        nav_button = self.findChild(QPushButton, "nav_业财看板")
        if nav_button:
            self.change_page(4, nav_button, "业财看板")

def switch_to_alert_center_view(self):
    """切换到预警中心视图"""
    if hasattr(self, "alert_center_view"):
        self.content_tabs.setCurrentWidget(self.alert_center_view)
        nav_button = self.findChild(QPushButton, "nav_预警中心")
        if nav_button:
            self.change_page(5, nav_button, "预警中心")
```

## 2. 修改后端API (app.py)

确保后端API支持业财看板和预警中心所需的数据接口。如果`app_fixed.py`中已经包含这些API，则无需修改。否则，需要添加以下API端点：

### 2.1 添加业财看板API

```python
# 项目统计数据API
@app.get("/api/projects/stats")
async def get_project_stats(current_user = Depends(get_current_user)):
    """获取项目统计数据"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # 获取总项目数
        total_projects = cursor.execute("SELECT COUNT(*) as count FROM business_events").fetchone()["count"]
        
        # 获取总预算
        total_budget = cursor.execute("SELECT SUM(amount) as total FROM budgets WHERE year = ?", 
                                     (datetime.now().year,)).fetchone()
        total_budget = total_budget["total"] if total_budget and total_budget["total"] else 0
        
        # 获取已完成项目数
        completed_projects = cursor.execute(
            "SELECT COUNT(*) as count FROM business_events WHERE status = '已完成'").fetchone()["count"]
        
        # 获取进行中项目数
        in_progress_projects = cursor.execute(
            "SELECT COUNT(*) as count FROM business_events WHERE status IN ('待审批', '审批中', '已审批')").fetchone()["count"]
        
        conn.close()
        
        return {
            "total_projects": total_projects,
            "total_budget": total_budget,
            "completed_projects": completed_projects,
            "in_progress_projects": in_progress_projects
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"获取项目统计数据失败: {str(e)}")

# 项目进度数据API
@app.get("/api/projects/progress")
async def get_project_progress(current_user = Depends(get_current_user)):
    """获取项目进度数据"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # 获取项目进度数据
        projects = cursor.execute("""
            SELECT project_name, planned_progress, actual_progress 
            FROM project_progress 
            ORDER BY project_name
            LIMIT 5
        """).fetchall()
        
        conn.close()
        
        if not projects:
            # 如果没有数据，返回模拟数据
            return {
                "names": ["项目A", "项目B", "项目C", "项目D", "项目E"],
                "planned_progress": [100, 80, 60, 40, 20],
                "actual_progress": [95, 70, 65, 30, 25]
            }
        
        # 格式化数据
        names = []
        planned_progress = []
        actual_progress = []
        
        for project in projects:
            names.append(project["project_name"])
            planned_progress.append(project["planned_progress"])
            actual_progress.append(project["actual_progress"])
        
        return {
            "names": names,
            "planned_progress": planned_progress,
            "actual_progress": actual_progress
        }
    except Exception as e:
        # 发生异常时返回模拟数据
        return {
            "names": ["项目A", "项目B", "项目C", "项目D", "项目E"],
            "planned_progress": [100, 80, 60, 40, 20],
            "actual_progress": [95, 70, 65, 30, 25]
        }

# 预算执行数据API
@app.get("/api/projects/budget")
async def get_project_budget(current_user = Depends(get_current_user)):
    """获取项目预算数据"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # 获取项目预算数据
        projects = cursor.execute("""
            SELECT p.name as project_name, b.amount as budget, b.used_amount as spent
            FROM projects p
            JOIN budgets b ON p.id = b.project_id
            WHERE b.year = ?
            ORDER BY p.name
            LIMIT 5
        """, (datetime.now().year,)).fetchall()
        
        conn.close()
        
        if not projects:
            # 如果没有数据，返回模拟数据
            return {
                "names": ["项目A", "项目B", "项目C", "项目D", "项目E"],
                "budget": [500000, 300000, 200000, 150000, 100000],
                "spent": [480000, 250000, 180000, 100000, 90000]
            }
        
        # 格式化数据
        names = []
        budget = []
        spent = []
        
        for project in projects:
            names.append(project["project_name"])
            budget.append(project["budget"])
            spent.append(project["spent"])
        
        return {
            "names": names,
            "budget": budget,
            "spent": spent
        }
    except Exception as e:
        # 发生异常时返回模拟数据
        return {
            "names": ["项目A", "项目B", "项目C", "项目D", "项目E"],
            "budget": [500000, 300000, 200000, 150000, 100000],
            "spent": [480000, 250000, 180000, 100000, 90000]
        }
```

### 2.2 添加预警中心API

```python
# 预警规则API
@app.get("/api/alert-rules")
async def get_alert_rules(current_user = Depends(get_current_user)):
    """获取预警规则列表"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # 获取预警规则
        rules = cursor.execute("""
            SELECT * FROM alert_rules
            ORDER BY id
        """).fetchall()
        
        conn.close()
        
        if not rules:
            # 如果没有数据，返回模拟数据
            return [
                {
                    "id": 1,
                    "name": "预算超支预警",
                    "indicator": "预算超支",
                    "condition": "大于",
                    "threshold": 10.0,
                    "severity": "高",
                    "is_active": True
                },
                {
                    "id": 2,
                    "name": "进度延迟预警",
                    "indicator": "进度延迟",
                    "condition": "大于",
                    "threshold": 15.0,
                    "severity": "中",
                    "is_active": True
                },
                {
                    "id": 3,
                    "name": "回款逾期预警",
                    "indicator": "回款逾期",
                    "condition": "大于",
                    "threshold": 30.0,
                    "severity": "高",
                    "is_active": True
                }
            ]
        
        return [dict(rule) for rule in rules]
    except Exception as e:
        # 发生异常时返回模拟数据
        return [
            {
                "id": 1,
                "name": "预算超支预警",
                "indicator": "预算超支",
                "condition": "大于",
                "threshold": 10.0,
                "severity": "高",
                "is_active": True
            },
            {
                "id": 2,
                "name": "进度延迟预警",
                "indicator": "进度延迟",
                "condition": "大于",
                "threshold": 15.0,
                "severity": "中",
                "is_active": True
            },
            {
                "id": 3,
                "name": "回款逾期预警",
                "indicator": "回款逾期",
                "condition": "大于",
                "threshold": 30.0,
                "severity": "高",
                "is_active": True
            }
        ]

# 预警记录API
@app.get("/api/alerts")
async def get_alerts(current_user = Depends(get_current_user)):
    """获取预警记录列表"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # 获取预警记录
        alerts = cursor.execute("""
            SELECT * FROM alerts
            ORDER BY time DESC
        """).fetchall()
        
        conn.close()
        
        if not alerts:
            # 如果没有数据，返回模拟数据
            return [
                {
                    "id": 1,
                    "time": "2023-06-15 10:30:00",
                    "rule_name": "预算超支预警",
                    "target": "项目A",
                    "current_value": 12.5,
                    "status": "未处理"
                },
                {
                    "id": 2,
                    "time": "2023-06-14 15:45:00",
                    "rule_name": "进度延迟预警",
                    "target": "项目B",
                    "current_value": 18.2,
                    "status": "未处理"
                },
                {
                    "id": 3,
                    "time": "2023-06-13 09:15:00",
                    "rule_name": "回款逾期预警",
                    "target": "项目C",
                    "current_value": 45.0,
                    "status": "未处理"
                }
            ]
        
        return [dict(alert) for alert in alerts]
    except Exception as e:
        # 发生异常时返回模拟数据
        return [
            {
                "id": 1,
                "time": "2023-06-15 10:30:00",
                "rule_name": "预算超支预警",
                "target": "项目A",
                "current_value": 12.5,
                "status": "未处理"
            },
            {
                "id": 2,
                "time": "2023-06-14 15:45:00",
                "rule_name": "进度延迟预警",
                "target": "项目B",
                "current_value": 18.2,
                "status": "未处理"
            },
            {
                "id": 3,
                "time": "2023-06-13 09:15:00",
                "rule_name": "回款逾期预警",
                "target": "项目C",
                "current_value": 45.0,
                "status": "未处理"
            }
        ]
```

## 3. 安装必要的依赖

确保安装了所有必要的Python包：

```bash
pip install matplotlib
pip install pandas
pip install numpy
```

## 4. 创建数据库表（如果需要）

如果数据库中还没有相关表，需要创建以下表：

### 4.1 项目进度表

```sql
CREATE TABLE IF NOT EXISTS project_progress (
    id INTEGER PRIMARY KEY,
    project_name TEXT NOT NULL,
    planned_progress REAL NOT NULL,
    actual_progress REAL NOT NULL,
    update_date TEXT NOT NULL
);
```

### 4.2 预警规则表

```sql
CREATE TABLE IF NOT EXISTS alert_rules (
    id INTEGER PRIMARY KEY,
    name TEXT NOT NULL,
    indicator TEXT NOT NULL,
    condition TEXT NOT NULL,
    threshold REAL NOT NULL,
    severity TEXT NOT NULL,
    is_active INTEGER NOT NULL DEFAULT 1
);
```

### 4.3 预警记录表

```sql
CREATE TABLE IF NOT EXISTS alerts (
    id INTEGER PRIMARY KEY,
    time TEXT NOT NULL,
    rule_name TEXT NOT NULL,
    target TEXT NOT NULL,
    current_value REAL NOT NULL,
    status TEXT NOT NULL DEFAULT '未处理'
);
```

## 5. 测试步骤

完成上述修改后，按照以下步骤测试功能：

1. 启动后端服务器：
   ```bash
   cd E:\pyChramAproject\trade\server
   python app.py
   ```

2. 启动前端应用程序：
   ```bash
   cd E:\pyChramAproject\trade\client
   python main.py
   ```

3. 使用管理员或财务人员账号登录系统

4. 在导航菜单中点击"业财看板"和"预警中心"，检查功能是否正常

## 6. 常见问题及解决方案

### 6.1 导入错误

**问题**：导入模块时出现错误
**解决方案**：
- 确保文件路径正确
- 检查模块名称是否正确
- 确保所有依赖包都已安装

### 6.2 API 404错误

**问题**：API请求返回404错误
**解决方案**：
- 确认API路径是否正确
- 检查后端服务器是否正常运行
- 确认API端点是否已正确定义

### 6.3 图表显示问题

**问题**：图表无法正常显示
**解决方案**：
- 确保matplotlib正确安装
- 检查数据格式是否正确
- 尝试使用简单的测试数据验证图表功能

### 6.4 权限问题

**问题**：某些用户无法访问功能
**解决方案**：
- 检查角色权限设置
- 确保用户角色正确
- 验证权限检查逻辑

## 7. 后续优化建议

1. **数据缓存**：实现数据缓存机制，减少API请求频率
2. **实时更新**：添加WebSocket支持，实现数据实时更新
3. **自定义看板**：允许用户自定义看板内容和布局
4. **导出功能**：添加数据和图表导出功能
5. **更多图表类型**：添加饼图、折线图等更多图表类型
6. **历史数据分析**：添加历史数据趋势分析功能
