# 创建财务记录闪退问题解决方案

## 问题描述

在业财融合管理系统中，点击"创建财务记录"按钮后，应用程序会直接闪退，无法正常创建财务记录。

## 问题原因分析

通过代码分析，发现可能的原因如下：

1. **业务事件状态更新API错误**：
   在 `FinancialRecordDialog` 类的 `save_data` 方法中，创建财务记录成功后尝试更新业务事件状态：
   ```python
   # 更新业务事件状态为已入账
   try:
       status_response = requests.post(
           f"http://localhost:8000/business_events/{business_event_id}/status",
           json={"status": "已入账"},
           headers={"Authorization": f"Bearer {self.token}"}
       )
   except:
       # 忽略状态更新错误
       pass
   ```
   
   但是在 `server/app.py` 中，没有 `/business_events/{event_id}/status` 这个API端点，正确的端点应该是 `/business_events/{event_id}/submit-to-approval` 或 `/approvals/{approval_id}/update-business-status`。

2. **会计科目选择问题**：
   在 `FinancialRecordDialog` 类中，可能存在会计科目选择的问题，导致 `account_code` 或 `account_name` 为空。

3. **用户角色权限问题**：
   后端API检查用户是否有财务角色：
   ```python
   # 检查用户是否有财务角色
   if current_user["role"] != "财务人员" and current_user["role"] != "管理员":
       raise HTTPException(status_code=403, detail="没有权限创建财务记录")
   ```
   当前用户可能没有正确的角色权限。

4. **异常处理不完善**：
   在创建财务记录的过程中，可能存在未捕获的异常导致应用程序崩溃。

## 解决方案

### 方案一：修复业务事件状态更新API（推荐）

1. 打开 `client/views/finance_view.py` 文件
2. 找到 `FinancialRecordDialog` 类的 `save_data` 方法
3. 修改状态更新代码：

```python
# 更新业务事件状态为已入账
try:
    # 获取关联的审批ID
    related_response = requests.get(
        f"http://localhost:8000/business_events/{business_event_id}/related",
        headers={"Authorization": f"Bearer {self.token}"}
    )
    
    if related_response.status_code == 200:
        related_data = related_response.json()
        approvals = related_data.get("approvals", [])
        
        if approvals:
            # 获取最新的审批ID
            approval_id = approvals[0]["id"]
            
            # 更新业务事件状态
            status_response = requests.post(
                f"http://localhost:8000/approvals/{approval_id}/update-business-status",
                json={"status": "已入账", "remarks": "财务记录已创建"},
                headers={"Authorization": f"Bearer {self.token}"}
            )
except Exception as e:
    print(f"获取审批ID或更新状态错误: {str(e)}")
    # 忽略错误，但记录日志
    pass
```

### 方案二：添加错误处理和日志输出

1. 打开 `client/views/finance_view.py` 文件
2. 找到 `FinancialRecordDialog` 类的 `save_data` 方法
3. 添加更详细的错误处理和日志输出：

```python
def save_data(self):
    """保存数据"""
    try:
        # 验证输入
        account_code = self.account_code_input.text()
        if not account_code:
            QMessageBox.warning(self, "输入错误", "请选择会计科目")
            return
        
        business_event_id = self.event_combo.currentData()
        if not business_event_id:
            QMessageBox.warning(self, "输入错误", "请选择关联业务事件")
            return
        
        amount = self.amount_input.value()
        if amount <= 0:
            QMessageBox.warning(self, "输入错误", "请输入有效金额")
            return
        
        # 构建数据
        data = {
            "business_event_id": business_event_id,
            "account_code": account_code,
            "account_name": self.account_name_input.text(),
            "amount": amount,
            "direction": self.direction_combo.currentData(),
            "record_date": self.date_input.date().toString("yyyy-MM-dd"),
            "fiscal_year": self.fiscal_year_input.value(),
            "fiscal_period": self.fiscal_period_input.value(),
            "description": self.description_input.toPlainText(),
        }
        
        print(f"准备发送的数据: {data}")  # 调试输出
        
        # 发送请求
        response = requests.post(
            "http://localhost:8000/financial_records",
            json=data,
            headers={"Authorization": f"Bearer {self.token}"}
        )
        
        print(f"响应状态码: {response.status_code}")  # 调试输出
        print(f"响应内容: {response.text}")  # 调试输出
        
        if response.status_code == 200:
            result = response.json()
            QMessageBox.information(self, "添加成功", f"财务记录已添加，ID: {result['id']}")
            
            # 不再尝试更新业务事件状态，避免错误
            self.accept()
        else:
            QMessageBox.warning(self, "添加失败", f"无法添加财务记录: {response.text}")
    except Exception as e:
        import traceback
        error_details = traceback.format_exc()
        print(f"保存数据时发生错误: {str(e)}")
        print(f"错误详情: {error_details}")
        QMessageBox.warning(self, "错误", f"保存数据时发生错误: {str(e)}")
```

### 方案三：检查用户角色

1. 打开 `client/views/finance_view.py` 文件
2. 找到 `FinancialRecordView` 类的 `show_add_dialog` 方法
3. 添加用户角色检查：

```python
def show_add_dialog(self):
    """显示添加财务记录对话框"""
    # 检查用户角色
    if self.user_data["role"] not in ["财务人员", "管理员"]:
        QMessageBox.warning(self, "权限不足", "只有财务人员或管理员可以创建财务记录")
        return
        
    if not self.business_events and not self.tabs.currentIndex() == 0:
        QMessageBox.warning(self, "无可用业务事件", "没有已审批的业务事件可以创建财务记录")
        return
        
    dialog = FinancialRecordDialog(self.token, self.user_data, 
                                  self.account_subjects, self.business_events)
    if dialog.exec() == QDialog.DialogCode.Accepted:
        self.load_data()
        self.load_business_events()  # 刷新待处理业务
```

### 方案四：创建简化版的财务记录创建对话框

如果上述方案都无法解决问题，可以创建一个简化版的财务记录创建对话框，避免使用可能导致问题的功能：

1. 打开 `client/views/finance_view.py` 文件
2. 在 `FinancialRecordView` 类中添加一个新方法：

```python
def show_simple_add_dialog(self):
    """显示简化版的添加财务记录对话框"""
    if not self.business_events:
        QMessageBox.warning(self, "无可用业务事件", "没有已审批的业务事件可以创建财务记录")
        return
        
    # 选择业务事件
    event_id, ok = QInputDialog.getItem(
        self, "选择业务事件", "请选择关联的业务事件:",
        [f"{e['id']} - {e['project_name']} (¥{e['amount']:,.2f})" for e in self.business_events],
        0, False
    )
    
    if not ok:
        return
        
    # 解析业务事件ID
    business_event_id = int(event_id.split(" - ")[0])
    
    # 选择会计科目
    if not self.account_subjects:
        QMessageBox.warning(self, "无可用会计科目", "没有可用的会计科目")
        return
        
    subject, ok = QInputDialog.getItem(
        self, "选择会计科目", "请选择会计科目:",
        [f"{s['code']} - {s['name']}" for s in self.account_subjects],
        0, False
    )
    
    if not ok:
        return
        
    # 解析会计科目
    account_code = subject.split(" - ")[0]
    account_name = subject.split(" - ")[1]
    
    # 选择方向
    direction, ok = QInputDialog.getItem(
        self, "选择方向", "请选择收支方向:",
        ["收入", "支出"],
        0, False
    )
    
    if not ok:
        return
        
    # 输入金额
    amount, ok = QInputDialog.getDouble(
        self, "输入金额", "请输入金额:",
        0, 0, 10000000, 2
    )
    
    if not ok or amount <= 0:
        return
        
    # 构建数据
    data = {
        "business_event_id": business_event_id,
        "account_code": account_code,
        "account_name": account_name,
        "amount": amount,
        "direction": direction,
        "record_date": QDate.currentDate().toString("yyyy-MM-dd"),
        "fiscal_year": datetime.now().year,
        "fiscal_period": datetime.now().month,
        "description": f"业务事件 {business_event_id} 的财务记录",
        "created_by": self.user_data["id"]
    }
    
    try:
        # 发送请求
        response = requests.post(
            "http://localhost:8000/financial_records",
            json=data,
            headers={"Authorization": f"Bearer {self.token}"}
        )
        
        if response.status_code == 200:
            result = response.json()
            QMessageBox.information(self, "添加成功", f"财务记录已添加，ID: {result['id']}")
            self.load_data()
            self.load_business_events()
        else:
            QMessageBox.warning(self, "添加失败", f"无法添加财务记录: {response.text}")
    except Exception as e:
        QMessageBox.warning(self, "错误", f"保存数据时发生错误: {str(e)}")
```

3. 修改 `init_ui` 方法，将"新建财务记录"按钮连接到新方法：

```python
# 新建按钮
self.add_button = QPushButton("新建财务记录")
self.add_button.clicked.connect(self.show_simple_add_dialog)  # 使用简化版对话框
top_layout.addWidget(self.add_button)
```

### 方案五：添加后端API端点

如果要保持原有的状态更新逻辑，可以在后端添加缺失的API端点：

1. 打开 `server/app.py` 文件
2. 添加 `/business_events/{event_id}/status` API端点：

```python
@app.post("/business_events/{event_id}/status")
async def update_business_event_status(
    event_id: int, 
    status_data: Dict[str, Any],
    current_user = Depends(get_current_user)
):
    new_status = status_data.get("status")
    
    if not new_status:
        raise HTTPException(status_code=400, detail="缺少状态参数")
    
    conn = get_db_connection()
    cursor = conn.cursor()
    
    # 检查业务事件是否存在
    event = cursor.execute("SELECT * FROM business_events WHERE id = ?", (event_id,)).fetchone()
    if not event:
        conn.close()
        raise HTTPException(status_code=404, detail="业务事件不存在")
    
    # 更新业务事件状态
    cursor.execute(
        "UPDATE business_events SET status = ? WHERE id = ?",
        (new_status, event_id)
    )
    
    # 记录状态变更历史（如果有状态历史表）
    try:
        cursor.execute("""
            INSERT INTO status_history (business_event_id, timestamp, status, operator, remarks)
            VALUES (?, datetime('now'), ?, ?, ?)
        """, (event_id, new_status, current_user["username"], "状态更新"))
    except:
        # 如果没有状态历史表，则忽略此步骤
        pass
    
    conn.commit()
    conn.close()
    
    return {"message": f"业务事件状态已更新为 {new_status}"}
```

## 调试步骤

如果上述方案仍然无法解决问题，可以添加更多调试输出来定位问题：

1. 在 `client/views/finance_view.py` 文件的开头添加日志配置：

```python
import logging
import sys

# 配置日志
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler("finance_view.log"),
        logging.StreamHandler(sys.stdout)
    ]
)
logger = logging.getLogger(__name__)
```

2. 在关键方法中添加日志输出：

```python
def show_add_dialog(self):
    """显示添加财务记录对话框"""
    logger.debug("开始显示添加财务记录对话框")
    
    if not self.business_events and not self.tabs.currentIndex() == 0:
        logger.warning("没有可用的业务事件")
        QMessageBox.warning(self, "无可用业务事件", "没有已审批的业务事件可以创建财务记录")
        return
    
    logger.debug(f"可用业务事件数量: {len(self.business_events)}")
    logger.debug(f"当前用户: {self.user_data}")
    
    try:
        dialog = FinancialRecordDialog(self.token, self.user_data, 
                                      self.account_subjects, self.business_events)
        logger.debug("对话框创建成功")
        
        if dialog.exec() == QDialog.DialogCode.Accepted:
            logger.debug("对话框接受，开始刷新数据")
            self.load_data()
            self.load_business_events()
            logger.debug("数据刷新完成")
    except Exception as e:
        logger.error(f"显示对话框时发生错误: {str(e)}", exc_info=True)
        QMessageBox.warning(self, "错误", f"显示对话框时发生错误: {str(e)}")
```

## 实施步骤总结

1. 选择一种解决方案（推荐方案一：修复业务事件状态更新API）
2. 修改相应的代码
3. 重启应用程序
4. 尝试创建财务记录，验证是否仍然闪退
5. 如果仍有问题，添加调试输出进一步排查

## 注意事项

- 修改代码前，建议先备份原始文件
- 如果使用方案四（简化版对话框），需要导入 `QInputDialog` 类
- 如果使用方案五（添加后端API端点），需要重启后端服务
- 如果添加日志配置，确保应用程序有写入日志文件的权限
