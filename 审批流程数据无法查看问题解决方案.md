# 审批流程数据无法查看问题解决方案

## 问题描述

在业财融合管理系统中，用户无法查看审批流程的数据。当进入审批管理界面时，没有显示任何审批记录，即使系统中存在审批数据。

## 问题原因分析

通过代码分析，发现主要原因如下：

1. **API端点限制**：
   在 `server/app.py` 中的 `/approvals` API端点有两个关键限制：
   ```python
   @app.get("/approvals")
   async def get_approvals(current_user = Depends(get_current_user)):
       conn = get_db_connection()
       approvals = conn.execute("""
           SELECT a.*, be.project_name, be.event_type, be.amount, u.username as approver_name
           FROM approvals a
           JOIN business_events be ON a.business_event_id = be.id
           JOIN users u ON a.approver_id = u.id
           WHERE a.approver_id = ? AND a.status = '待审批'
           ORDER BY a.created_at DESC
       """, (current_user["id"],)).fetchall()
       conn.close()
       return [dict(approval) for approval in approvals]
   ```

   这个API有两个重要限制：
   - 只返回当前登录用户是审批人的记录（`approver_id = current_user["id"]`）
   - 只返回状态为"待审批"的记录（已处理的审批不会显示）

2. **审批配置问题**：
   当前登录用户可能没有在 `approval_configs` 表中配置审批权限。

3. **用户角色问题**：
   用户的角色可能不是审批人，或者没有被分配审批任务。

## 解决方案

### 方案一：修改现有API端点（推荐）

修改 `server/app.py` 中的 `/approvals` API端点，根据用户角色返回不同范围的审批记录：

1. 打开 `server/app.py` 文件
2. 找到 `@app.get("/approvals")` 函数（约在第353行）
3. 将其修改为：

```python
@app.get("/approvals")
async def get_approvals(current_user = Depends(get_current_user)):
    conn = get_db_connection()
    
    # 管理员可以查看所有审批
    if current_user["role"] == "管理员":
        approvals = conn.execute("""
            SELECT a.*, be.project_name, be.event_type, be.amount, u.username as approver_name
            FROM approvals a
            JOIN business_events be ON a.business_event_id = be.id
            JOIN users u ON a.approver_id = u.id
            ORDER BY a.created_at DESC
        """).fetchall()
    else:
        # 普通用户只能查看自己的待审批记录
        approvals = conn.execute("""
            SELECT a.*, be.project_name, be.event_type, be.amount, u.username as approver_name
            FROM approvals a
            JOIN business_events be ON a.business_event_id = be.id
            JOIN users u ON a.approver_id = u.id
            WHERE a.approver_id = ? AND a.status = '待审批'
            ORDER BY a.created_at DESC
        """, (current_user["id"],)).fetchall()
    
    conn.close()
    return [dict(approval) for approval in approvals]
```

### 方案二：添加新的API端点

如果不想修改现有API，可以添加一个新的API端点，专门用于查看所有审批记录：

1. 打开 `server/app.py` 文件
2. 在适当位置（例如其他API端点之后）添加以下代码：

```python
@app.get("/all_approvals")
async def get_all_approvals(current_user = Depends(get_current_user)):
    # 检查用户权限（只允许管理员或有特定角色的用户查看所有审批）
    if current_user["role"] not in ["管理员", "财务人员"]:
        raise HTTPException(status_code=403, detail="没有权限查看所有审批记录")
    
    conn = get_db_connection()
    approvals = conn.execute("""
        SELECT a.*, be.project_name, be.event_type, be.amount, u.username as approver_name
        FROM approvals a
        JOIN business_events be ON a.business_event_id = be.id
        JOIN users u ON a.approver_id = u.id
        ORDER BY a.created_at DESC
    """).fetchall()
    conn.close()
    return [dict(approval) for approval in approvals]
```

3. 然后修改前端代码，添加使用新API的功能：

```python
# 在 client/views/approval_view.py 中添加
def load_all_approvals(self):
    """加载所有审批数据（仅管理员可用）"""
    if self.user_data["role"] != "管理员":
        QMessageBox.warning(self, "权限不足", "只有管理员可以查看所有审批记录")
        return
    
    try:
        response = requests.get(
            "http://localhost:8000/all_approvals",
            headers={"Authorization": f"Bearer {self.token}"}
        )
        
        if response.status_code == 200:
            self.data = response.json()
            self.display_data()
        else:
            QMessageBox.warning(self, "加载失败", "无法加载所有审批数据")
    except Exception as e:
        QMessageBox.warning(self, "错误", f"加载审批数据时发生错误: {str(e)}")
```

### 方案三：修改前端显示逻辑

如果只想查看审批记录而不关心是否能进行审批操作，可以修改前端显示逻辑：

1. 打开 `client/views/approval_view.py` 文件
2. 修改 `load_data` 方法，使用 `/business_events` API获取所有业务事件，然后通过 `/business_events/{event_id}/related` API获取关联的审批记录：

```python
def load_data(self):
    """加载审批数据"""
    try:
        # 先获取所有业务事件
        response = requests.get(
            "http://localhost:8000/business_events",
            headers={"Authorization": f"Bearer {self.token}"}
        )
        
        if response.status_code == 200:
            business_events = response.json()
            
            # 存储所有审批记录
            all_approvals = []
            
            # 对每个业务事件，获取关联的审批记录
            for event in business_events:
                related_response = requests.get(
                    f"http://localhost:8000/business_events/{event['id']}/related",
                    headers={"Authorization": f"Bearer {self.token}"}
                )
                
                if related_response.status_code == 200:
                    related_data = related_response.json()
                    approvals = related_data.get("approvals", [])
                    
                    # 为每个审批记录添加业务事件信息
                    for approval in approvals:
                        approval["project_name"] = event["project_name"]
                        approval["event_type"] = event["event_type"]
                        approval["amount"] = event["amount"]
                        approval["business_event_id"] = event["id"]
                        all_approvals.append(approval)
            
            self.data = all_approvals
            self.display_data()
        else:
            QMessageBox.warning(self, "加载失败", "无法加载业务事件数据")
    except Exception as e:
        QMessageBox.warning(self, "错误", f"加载审批数据时发生错误: {str(e)}")
```

## 检查审批配置

除了修改代码外，还需要确保系统中有正确的审批配置：

1. 检查 `approval_configs` 表中是否有当前用户作为审批人的配置：

```sql
-- 在SQLite命令行或管理工具中执行
SELECT * FROM approval_configs WHERE approver_id = 当前用户ID;
```

2. 如果没有，可以添加配置：

```sql
INSERT INTO approval_configs (event_type, department_id, approver_id, approval_level, amount_threshold, is_active)
VALUES ('销售', 3, 当前用户ID, 1, 10000.00, 1);
```

## 调试步骤

如果修改后仍然无法查看审批数据，可以添加调试输出来定位问题：

1. 在前端 `load_data` 方法中添加调试输出：

```python
def load_data(self):
    """加载审批数据"""
    try:
        print(f"当前用户: {self.user_data}")  # 打印当前用户信息
        
        response = requests.get(
            "http://localhost:8000/approvals",
            headers={"Authorization": f"Bearer {self.token}"}
        )
        
        print(f"响应状态码: {response.status_code}")  # 打印响应状态码
        print(f"响应内容: {response.text}")  # 打印响应内容
        
        if response.status_code == 200:
            self.data = response.json()
            print(f"解析后的数据: {self.data}")  # 打印解析后的数据
            print(f"数据长度: {len(self.data)}")  # 打印数据长度
            self.display_data()
        else:
            QMessageBox.warning(self, "加载失败", "无法加载审批数据")
    except Exception as e:
        QMessageBox.warning(self, "错误", f"加载审批数据时发生错误: {str(e)}")
```

2. 在后端API中添加调试输出：

```python
@app.get("/approvals")
async def get_approvals(current_user = Depends(get_current_user)):
    print(f"当前用户: {current_user}")  # 打印当前用户信息
    
    conn = get_db_connection()
    
    # 查询SQL
    query = """
        SELECT a.*, be.project_name, be.event_type, be.amount, u.username as approver_name
        FROM approvals a
        JOIN business_events be ON a.business_event_id = be.id
        JOIN users u ON a.approver_id = u.id
        WHERE a.approver_id = ? AND a.status = '待审批'
        ORDER BY a.created_at DESC
    """
    print(f"SQL查询: {query}")  # 打印SQL查询
    print(f"参数: {current_user['id']}")  # 打印参数
    
    approvals = conn.execute(query, (current_user["id"],)).fetchall()
    
    result = [dict(approval) for approval in approvals]
    print(f"查询结果: {result}")  # 打印查询结果
    
    conn.close()
    return result
```

## 实施步骤总结

1. 选择一种解决方案（推荐方案一：修改现有API端点）
2. 修改相应的代码
3. 重启后端服务
4. 重新登录系统
5. 进入审批管理界面，验证是否能看到审批数据
6. 如果仍有问题，添加调试输出进一步排查

## 注意事项

- 修改API后，确保前端代码能正确处理返回的数据格式
- 对于管理员用户，可能需要在界面上添加过滤功能，以便更好地管理大量审批记录
- 考虑添加分页功能，避免一次加载过多数据影响性能
