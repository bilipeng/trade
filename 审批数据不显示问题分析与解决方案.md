# 审批数据不显示问题分析与解决方案

## 问题描述

在业财融合管理系统中，当用户成功提交业务事件到审批流程后（收到成功提示），切换到审批管理界面却看不到该条待审批的数据。即使点击刷新按钮，也无法看到新提交的审批数据。

## 问题日志分析

根据系统日志，我们可以观察到以下关键信息：

1. 管理员用户(admin)登录时，系统返回了6条审批记录，但这些记录的状态都是"已通过"或"已拒绝"，没有"待审批"状态的记录：
   ```
   当前用户: {'id': 1, 'username': 'admin', 'role': '管理员', 'department': '系统管理', 'email': 'admin@example.com'}
   响应状态码: 200
   响应内容: [{"id":26,"business_event_id":26,"approver_id":1,"approval_level":1,"status":"已通过",...}]
   ```

2. 业务事件34成功提交到审批流程（API返回200状态码）：
   ```
   提交业务事件 34 到审批流程
   响应状态码: 200
   响应内容: {"message":"业务事件已成功提交到审批流程"}
   ```

3. 刷新审批数据后，仍然只显示之前的6条记录，没有业务事件34的审批记录。

## 问题原因分析

通过分析系统代码和日志，我们发现以下可能的原因：

### 1. API端点筛选条件问题

在`server/app.py`中的`/approvals`端点，即使对管理员用户，也可能存在隐含的筛选条件，例如只返回特定状态的审批记录。

### 2. 审批任务创建问题

虽然提交业务事件到审批流程的API调用成功了，但这并不一定意味着审批任务被成功创建。可能的原因包括：

- 没有找到匹配的审批配置
- 审批任务创建逻辑有问题
- 审批任务创建成功，但状态不是"待审批"

### 3. 数据库查询问题

`/approvals`端点的SQL查询可能存在问题，导致无法正确获取新创建的审批任务。

### 4. 前端刷新机制问题

即使审批任务创建成功，前端的刷新机制可能没有正确获取最新的数据。

## 解决方案

### 方案一：修改API端点，添加状态筛选参数（推荐）

1. 打开`server/app.py`文件
2. 找到`/approvals`端点
3. 修改代码，添加状态筛选参数：

```python
@app.get("/approvals")
async def get_approvals(status: str = None, current_user = Depends(get_current_user)):
    conn = get_db_connection()
    
    # 构建基本查询
    query = """
        SELECT a.*, be.project_name, be.event_type, be.amount, u.username as approver_name
        FROM approvals a
        JOIN business_events be ON a.business_event_id = be.id
        JOIN users u ON a.approver_id = u.id
    """
    params = []
    
    # 添加条件
    conditions = []
    
    # 非管理员只能查看自己的审批
    if current_user["role"] != "管理员":
        conditions.append("a.approver_id = ?")
        params.append(current_user["id"])
    
    # 如果指定了状态，添加状态筛选
    if status:
        conditions.append("a.status = ?")
        params.append(status)
    
    # 组合条件
    if conditions:
        query += " WHERE " + " AND ".join(conditions)
    
    # 添加排序
    query += " ORDER BY a.created_at DESC"
    
    # 执行查询
    approvals = conn.execute(query, params).fetchall()
    conn.close()
    
    return [dict(approval) for approval in approvals]
```

### 方案二：修改前端代码，添加状态筛选功能

1. 打开`client/views/approval_view.py`文件
2. 修改`load_data`方法，添加状态筛选参数：

```python
def load_data(self, status=None):
    """加载审批数据"""
    try:
        print(f"当前用户: {self.user_data}")
        
        # 构建URL
        url = "http://localhost:8000/approvals"
        if status:
            url += f"?status={status}"
            
        response = requests.get(
            url,
            headers={"Authorization": f"Bearer {self.token}"}
        )
        
        print(f"响应状态码: {response.status_code}")
        print(f"响应内容: {response.text}")
        
        if response.status_code == 200:
            self.data = response.json()
            print(f"解析后的数据: {self.data}")
            print(f"数据长度: {len(self.data)}")
            self.display_data()
        else:
            QMessageBox.warning(self, "加载失败", "无法加载审批数据")
    except Exception as e:
        print(f"加载审批数据时发生错误: {str(e)}")
        QMessageBox.warning(self, "错误", f"加载审批数据时发生错误: {str(e)}")
```

3. 在`init_ui`方法中添加状态筛选下拉菜单：

```python
# 状态筛选下拉菜单
self.status_filter = QComboBox()
self.status_filter.addItem("全部", None)
self.status_filter.addItem("待审批", "待审批")
self.status_filter.addItem("已通过", "已通过")
self.status_filter.addItem("已拒绝", "已拒绝")
self.status_filter.currentIndexChanged.connect(self.filter_by_status)
filter_layout.addWidget(QLabel("状态:"))
filter_layout.addWidget(self.status_filter)
```

4. 添加状态筛选方法：

```python
def filter_by_status(self):
    """按状态筛选"""
    status = self.status_filter.currentData()
    self.load_data(status)
```

### 方案三：修改提交审批的API端点，确保正确创建审批任务

1. 打开`server/app.py`文件
2. 找到`/business_events/{event_id}/submit-to-approval`端点
3. 修改代码，添加更多的错误处理和默认配置：

```python
@app.post("/business_events/{event_id}/submit-to-approval")
async def submit_to_approval(event_id: int, current_user = Depends(get_current_user)):
    print(f"提交业务事件 {event_id} 到审批流程，用户: {current_user['username']}")
    
    conn = get_db_connection()
    cursor = conn.cursor()
    
    # 检查业务事件是否存在
    event = cursor.execute("SELECT * FROM business_events WHERE id = ?", (event_id,)).fetchone()
    if not event:
        conn.close()
        print(f"业务事件 {event_id} 不存在")
        raise HTTPException(status_code=404, detail="业务事件不存在")
    
    event_data = dict(event)
    print(f"业务事件数据: {event_data}")
    
    # 检查当前状态是否允许提交审批
    if event_data["status"] not in ["新建", "待审批"]:
        conn.close()
        print(f"业务事件状态 {event_data['status']} 不允许提交审批")
        raise HTTPException(status_code=400, detail="当前状态不允许提交审批")
    
    # 创建审批任务（如果尚未创建）
    existing_approvals = cursor.execute(
        "SELECT COUNT(*) as count FROM approvals WHERE business_event_id = ?", 
        (event_id,)
    ).fetchone()
    
    print(f"现有审批数量: {existing_approvals['count']}")
    
    if existing_approvals["count"] == 0:
        # 查询匹配的审批配置
        configs = cursor.execute("""
            SELECT * FROM approval_configs
            WHERE event_type = ? AND department_id = ? AND is_active = 1
            AND (amount_threshold IS NULL OR amount_threshold <= ?)
            ORDER BY approval_level
        """, (event_data["event_type"], event_data["department_id"], event_data["amount"])).fetchall()
        
        print(f"匹配的审批配置数量: {len(configs)}")
        
        # 如果没有找到匹配的审批配置，使用默认配置
        if len(configs) == 0:
            print("没有找到匹配的审批配置，使用默认配置")
            # 默认分配给管理员审批
            cursor.execute("""
                INSERT INTO approvals (business_event_id, approver_id, approval_level, status)
                SELECT ?, id, 1, '待审批'
                FROM users
                WHERE role = '管理员'
                LIMIT 1
            """, (event_id,))
        else:
            # 创建审批流程
            for config in configs:
                print(f"创建审批任务: 审批人ID={config['approver_id']}, 级别={config['approval_level']}")
                cursor.execute("""
                    INSERT INTO approvals (business_event_id, approver_id, approval_level, status)
                    VALUES (?, ?, ?, '待审批')
                """, (event_id, config["approver_id"], config["approval_level"]))
    
    # 更新业务事件状态
    cursor.execute(
        "UPDATE business_events SET status = '待审批' WHERE id = ?",
        (event_id,)
    )
    
    conn.commit()
    conn.close()
    
    return {"message": "业务事件已成功提交到审批流程"}
```

### 方案四：添加直接查询审批任务的功能

1. 在`client/views/approval_view.py`文件中添加一个方法，用于直接查询特定业务事件的审批任务：

```python
def load_business_approvals(self, business_id):
    """加载特定业务事件的审批任务"""
    try:
        response = requests.get(
            f"http://localhost:8000/business_events/{business_id}/approvals",
            headers={"Authorization": f"Bearer {self.token}"}
        )
        
        if response.status_code == 200:
            approvals = response.json()
            if approvals:
                QMessageBox.information(self, "查询结果", f"找到 {len(approvals)} 条审批记录")
                self.data = approvals
                self.display_data()
            else:
                QMessageBox.warning(self, "查询结果", "没有找到审批记录")
        else:
            QMessageBox.warning(self, "查询失败", "无法获取审批记录")
    except Exception as e:
        QMessageBox.warning(self, "错误", f"查询审批记录时发生错误: {str(e)}")
```

2. 在`server/app.py`文件中添加一个新的API端点：

```python
@app.get("/business_events/{event_id}/approvals")
async def get_business_approvals(event_id: int, current_user = Depends(get_current_user)):
    conn = get_db_connection()
    
    approvals = conn.execute("""
        SELECT a.*, be.project_name, be.event_type, be.amount, u.username as approver_name
        FROM approvals a
        JOIN business_events be ON a.business_event_id = be.id
        JOIN users u ON a.approver_id = u.id
        WHERE a.business_event_id = ?
        ORDER BY a.approval_level
    """, (event_id,)).fetchall()
    
    conn.close()
    return [dict(approval) for approval in approvals]
```

### 方案五：手动创建审批任务（临时解决方案）

如果您需要立即解决问题，可以手动为业务事件34创建审批任务：

```sql
-- 手动创建审批任务，将admin(ID=1)设为审批人
INSERT INTO approvals (business_event_id, approver_id, approval_level, status)
VALUES (34, 1, 1, '待审批');

-- 确保业务事件状态为"待审批"
UPDATE business_events SET status = '待审批' WHERE id = 34;
```

## 实施步骤

### 步骤一：检查审批任务是否创建成功

1. 使用SQLite命令行工具或其他数据库管理工具连接到数据库
2. 执行以下SQL查询：
   ```sql
   SELECT * FROM approvals WHERE business_event_id = 34;
   ```
3. 如果查询返回结果，说明审批任务已创建；如果没有结果，说明审批任务创建失败

### 步骤二：修改API端点，添加状态筛选参数

1. 打开`server/app.py`文件
2. 找到`/approvals`端点
3. 修改代码，添加状态筛选参数（参考方案一）
4. 保存文件
5. 重启后端服务

### 步骤三：修改前端代码，添加状态筛选功能

1. 打开`client/views/approval_view.py`文件
2. 修改`load_data`方法，添加状态筛选参数（参考方案二）
3. 在`init_ui`方法中添加状态筛选下拉菜单
4. 添加状态筛选方法
5. 保存文件
6. 重启前端应用

### 步骤四：测试修改效果

1. 登录系统
2. 创建一个新的业务事件
3. 提交到审批流程
4. 切换到审批管理界面
5. 在状态筛选下拉菜单中选择"待审批"
6. 验证是否能看到新提交的审批任务

## 预防措施

为了避免类似问题再次发生，建议采取以下预防措施：

1. **完善日志记录**：
   - 在关键操作（如提交审批、创建审批任务）中添加详细的日志记录
   - 记录操作的输入参数、执行结果和可能的错误

2. **增强错误处理**：
   - 在API端点中添加更多的错误处理逻辑
   - 对可能的异常情况进行处理，并返回明确的错误信息

3. **添加默认配置**：
   - 为没有匹配审批配置的业务事件添加默认配置
   - 确保每个业务事件都能创建审批任务

4. **改进前端交互**：
   - 添加更多的状态反馈，如加载指示器、成功/失败提示
   - 提供更多的筛选和查询选项，方便用户查找审批任务

5. **定期维护审批配置**：
   - 定期检查审批配置是否完整
   - 确保每种业务事件类型和部门都有对应的审批配置

## 总结

审批数据不显示的问题主要是由于API端点的筛选条件和审批任务创建逻辑导致的。通过修改API端点、添加状态筛选功能、完善审批任务创建逻辑，可以有效解决这个问题。

对于紧急情况，可以手动创建审批任务作为临时解决方案。长期来看，应该完善系统的日志记录、错误处理和默认配置，以提高系统的稳定性和用户体验。
