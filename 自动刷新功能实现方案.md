# è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½å®ç°æ–¹æ¡ˆ

## éœ€æ±‚æ¦‚è¿°

åœ¨ä¸šè´¢èåˆç®¡ç†ç³»ç»Ÿä¸­ï¼Œéœ€è¦å®ç°ä»¥ä¸‹è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½ï¼š

1. æ¯æ¬¡å®Œæˆæ“ä½œåè‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼ˆå¦‚æäº¤å®¡æ ¸ã€é€šè¿‡å®¡æ ¸ç­‰ï¼‰
2. ç¡®ä¿ç”¨æˆ·å§‹ç»ˆçœ‹åˆ°æœ€æ–°çš„æ•°æ®çŠ¶æ€
3. é¿å…ç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°çš„éº»çƒ¦
4. æé«˜ç³»ç»Ÿçš„å®æ—¶æ€§å’Œç”¨æˆ·ä½“éªŒ

## å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šæ“ä½œåè‡ªåŠ¨è°ƒç”¨åˆ·æ–°æ–¹æ³•ï¼ˆæ¨èï¼‰

è¿™æ˜¯æœ€ç›´æ¥çš„æ–¹æ¡ˆï¼Œåœ¨æ¯ä¸ªæ“ä½œå®Œæˆåç›´æ¥è°ƒç”¨ç›¸åº”è§†å›¾çš„åˆ·æ–°æ–¹æ³•ã€‚

#### 1. åœ¨ä¸»çª—å£ä¸­æ·»åŠ å…¨å±€åˆ·æ–°æ–¹æ³•

åœ¨`main_window.py`ä¸­æ·»åŠ å…¨å±€åˆ·æ–°æ–¹æ³•ï¼š

```python
def refresh_current_view(self):
    """åˆ·æ–°å½“å‰è§†å›¾çš„æ•°æ®"""
    current_widget = self.content_tabs.currentWidget()
    
    if hasattr(current_widget, "load_data"):
        try:
            # æ˜¾ç¤ºåˆ·æ–°ä¸­çš„çŠ¶æ€
            self.statusBar.showMessage("æ­£åœ¨åˆ·æ–°æ•°æ®...", 2000)
            
            # è°ƒç”¨å½“å‰è§†å›¾çš„load_dataæ–¹æ³•
            current_widget.load_data()
            
            # æ›´æ–°çŠ¶æ€æ 
            self.statusBar.showMessage("æ•°æ®åˆ·æ–°æˆåŠŸ", 2000)
        except Exception as e:
            self.statusBar.showMessage(f"åˆ·æ–°å¤±è´¥: {str(e)}", 3000)
            QMessageBox.warning(self, "åˆ·æ–°å¤±è´¥", f"åˆ·æ–°æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}")
    else:
        self.statusBar.showMessage("å½“å‰è§†å›¾ä¸æ”¯æŒåˆ·æ–°", 2000)
```

#### 2. ä¿®æ”¹ä¸šåŠ¡è§†å›¾ä¸­çš„æ“ä½œæ–¹æ³•

åœ¨`views/business_view.py`ä¸­ä¿®æ”¹æäº¤å®¡æ‰¹æ–¹æ³•ï¼š

```python
def submit_to_approval(self, business_id):
    """æäº¤ä¸šåŠ¡äº‹ä»¶è‡³å®¡æ‰¹æµç¨‹"""
    try:
        # è°ƒç”¨æ–°APIå°†ä¸šåŠ¡äº‹ä»¶æäº¤åˆ°å®¡æ‰¹æµç¨‹
        response = requests.post(
            f"http://localhost:8000/business_events/{business_id}/submit-to-approval",
            headers={"Authorization": f"Bearer {self.token}"}
        )
        
        if response.status_code == 200:
            QMessageBox.information(self, "æäº¤æˆåŠŸ", "ä¸šåŠ¡äº‹ä»¶å·²æˆåŠŸæäº¤åˆ°å®¡æ‰¹æµç¨‹")
            
            # è‡ªåŠ¨åˆ·æ–°æ•°æ®
            self.load_data()
            
            # å¦‚æœç”¨æˆ·ç¡®è®¤ï¼Œåˆ‡æ¢åˆ°å®¡æ‰¹ç®¡ç†ç•Œé¢
            reply = QMessageBox.question(
                self, "æäº¤æˆåŠŸ", 
                "ä¸šåŠ¡äº‹ä»¶å·²æˆåŠŸæäº¤åˆ°å®¡æ‰¹æµç¨‹ï¼Œæ˜¯å¦ç«‹å³è·³è½¬åˆ°å®¡æ‰¹ç®¡ç†ç•Œé¢ï¼Ÿ",
                QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No,
                QMessageBox.StandardButton.Yes
            )
            
            if reply == QMessageBox.StandardButton.Yes:
                # æ‰¾åˆ°ä¸»çª—å£
                main_window = self.window()
                if main_window and hasattr(main_window, "content_tabs") and hasattr(main_window, "approval_view"):
                    # åˆ‡æ¢åˆ°å®¡æ‰¹ç®¡ç†é€‰é¡¹å¡
                    main_window.content_tabs.setCurrentWidget(main_window.approval_view)
                    
                    # åˆ·æ–°å®¡æ‰¹è§†å›¾æ•°æ®
                    main_window.approval_view.load_data()
                else:
                    QMessageBox.information(self, "æç¤º", "è¯·æ‰‹åŠ¨åˆ‡æ¢åˆ°å®¡æ‰¹ç®¡ç†ç•Œé¢æŸ¥çœ‹è¯¦æƒ…")
        else:
            QMessageBox.warning(self, "æäº¤å¤±è´¥", f"æäº¤åˆ°å®¡æ‰¹æµç¨‹å¤±è´¥: {response.text}")
    except Exception as e:
        QMessageBox.warning(self, "é”™è¯¯", f"æäº¤è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {str(e)}")
```

#### 3. ä¿®æ”¹å®¡æ‰¹è§†å›¾ä¸­çš„æ“ä½œæ–¹æ³•

åœ¨`views/approval_view.py`ä¸­ä¿®æ”¹å®¡æ‰¹é€šè¿‡æ–¹æ³•ï¼š

```python
def approve(self, approval_id):
    """å®¡æ‰¹é€šè¿‡"""
    reply = QMessageBox.question(
        self, 'ç¡®è®¤æ“ä½œ', 
        "ç¡®å®šè¦é€šè¿‡æ­¤å®¡æ‰¹å—ï¼Ÿ", 
        QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No, 
        QMessageBox.StandardButton.No
    )
    
    if reply == QMessageBox.StandardButton.Yes:
        try:
            response = requests.post(
                f"http://localhost:8000/approvals/{approval_id}/approve",
                headers={"Authorization": f"Bearer {self.token}"}
            )
            
            if response.status_code == 200:
                result = response.json()
                QMessageBox.information(self, "æ“ä½œæˆåŠŸ", "å®¡æ‰¹å·²é€šè¿‡")
                
                # è‡ªåŠ¨åˆ·æ–°æ•°æ®
                self.load_data()
                
                # å¦‚æœæ‰€æœ‰å®¡æ‰¹éƒ½å·²å®Œæˆï¼Œæ˜¾ç¤ºåˆ›å»ºè´¢åŠ¡è®°å½•çš„è¯¢é—®
                if not result.get("next_approval", True):
                    self.prompt_create_finance_record(approval_id)
            else:
                QMessageBox.warning(self, "æ“ä½œå¤±è´¥", f"å®¡æ‰¹é€šè¿‡å¤±è´¥: {response.text}")
        except Exception as e:
            QMessageBox.warning(self, "é”™è¯¯", f"æ“ä½œæ—¶å‘ç”Ÿé”™è¯¯: {str(e)}")
```

åŒæ ·ä¿®æ”¹å®¡æ‰¹æ‹’ç»æ–¹æ³•ã€‚

#### 4. ä¿®æ”¹è´¢åŠ¡è§†å›¾ä¸­çš„æ“ä½œæ–¹æ³•

åœ¨`views/finance_view.py`ä¸­ä¿®æ”¹åˆ›å»ºè´¢åŠ¡è®°å½•æ–¹æ³•ï¼š

```python
def save_data(self):
    """ä¿å­˜æ•°æ®"""
    # éªŒè¯è¾“å…¥
    # ...
    
    try:
        # å‘é€è¯·æ±‚
        response = requests.post(
            "http://localhost:8000/financial_records",
            json=data,
            headers={"Authorization": f"Bearer {self.token}"}
        )
        
        if response.status_code == 200:
            result = response.json()
            QMessageBox.information(self, "æ·»åŠ æˆåŠŸ", f"è´¢åŠ¡è®°å½•å·²æ·»åŠ ï¼ŒID: {result['id']}")
            
            # è‡ªåŠ¨åˆ·æ–°æ•°æ®
            self.load_data()
            
            # æ›´æ–°ä¸šåŠ¡äº‹ä»¶çŠ¶æ€ä¸ºå·²å…¥è´¦
            try:
                status_response = requests.post(
                    f"http://localhost:8000/business_events/{business_event_id}/status",
                    json={"status": "å·²å…¥è´¦"},
                    headers={"Authorization": f"Bearer {self.token}"}
                )
            except:
                # å¿½ç•¥çŠ¶æ€æ›´æ–°é”™è¯¯
                pass
            
            self.accept()
        else:
            QMessageBox.warning(self, "æ·»åŠ å¤±è´¥", f"æ— æ³•æ·»åŠ è´¢åŠ¡è®°å½•: {response.text}")
    except Exception as e:
        QMessageBox.warning(self, "é”™è¯¯", f"ä¿å­˜æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯: {str(e)}")
```

### æ–¹æ¡ˆäºŒï¼šæ·»åŠ è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨

è¿™ç§æ–¹æ¡ˆä¼šå®šæœŸè‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼Œä¸ä¾èµ–äºç”¨æˆ·æ“ä½œã€‚

#### 1. åœ¨ä¸»çª—å£ä¸­æ·»åŠ å®šæ—¶å™¨

åœ¨`main_window.py`çš„`__init__`æ–¹æ³•ä¸­æ·»åŠ å®šæ—¶å™¨ï¼š

```python
from PyQt6.QtCore import QTimer

def __init__(self):
    super().__init__()
    self.settings = QSettings("FinanceApp", "BizFinanceSystem")
    self.user_data = None
    self.token = None
    
    # æ·»åŠ è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
    self.refresh_timer = QTimer(self)
    self.refresh_timer.timeout.connect(self.auto_refresh)
    
    # æ£€æŸ¥æ˜¯å¦å·²æœ‰tokenï¼Œå¦‚æœæœ‰å°è¯•è‡ªåŠ¨ç™»å½•
    token = self.settings.value("access_token", "")
    if token:
        self.try_auto_login(token)
    else:
        self.show_login()
```

#### 2. æ·»åŠ è‡ªåŠ¨åˆ·æ–°æ–¹æ³•

```python
def auto_refresh(self):
    """è‡ªåŠ¨åˆ·æ–°å½“å‰è§†å›¾"""
    # è·å–å½“å‰è§†å›¾
    current_widget = self.content_tabs.currentWidget()
    
    # å¦‚æœå½“å‰è§†å›¾æœ‰load_dataæ–¹æ³•ï¼Œè°ƒç”¨å®ƒ
    if hasattr(current_widget, "load_data"):
        try:
            current_widget.load_data()
            self.statusBar.showMessage("æ•°æ®å·²è‡ªåŠ¨åˆ·æ–°", 1000)
        except Exception as e:
            # è‡ªåŠ¨åˆ·æ–°å‡ºé”™æ—¶ä¸æ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†ï¼Œåªåœ¨çŠ¶æ€æ æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            self.statusBar.showMessage(f"è‡ªåŠ¨åˆ·æ–°å¤±è´¥: {str(e)}", 2000)
```

#### 3. åœ¨ç™»å½•æˆåŠŸåå¯åŠ¨å®šæ—¶å™¨

åœ¨`login_successful`æ–¹æ³•ä¸­å¯åŠ¨å®šæ—¶å™¨ï¼š

```python
def login_successful(self, data):
    """ç™»å½•æˆåŠŸåçš„å¤„ç†"""
    self.user_data = data["user"]
    self.token = data["token"]
    
    # å¦‚æœç™»å½•çª—å£å­˜åœ¨ï¼Œå…³é—­å®ƒ
    if hasattr(self, 'login_window') and self.login_window is not None:
        self.login_window.close()
        self.login_window = None
        
    # åˆå§‹åŒ–ä¸»ç•Œé¢
    self.init_ui()
    
    # å¯åŠ¨è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨ï¼ˆæ¯60ç§’åˆ·æ–°ä¸€æ¬¡ï¼‰
    refresh_interval = self.settings.value("refresh_interval", 60000, type=int)
    self.refresh_timer.start(refresh_interval)
    
    self.show()
```

#### 4. åœ¨é€€å‡ºç™»å½•æ—¶åœæ­¢å®šæ—¶å™¨

åœ¨`logout`æ–¹æ³•ä¸­åœæ­¢å®šæ—¶å™¨ï¼š

```python
def logout(self):
    """é€€å‡ºç™»å½•"""
    reply = QMessageBox.question(
        self, 
        'ç¡®è®¤é€€å‡º', 
        'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
        QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No, 
        QMessageBox.StandardButton.No
    )
    
    if reply == QMessageBox.StandardButton.Yes:
        # åœæ­¢è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
        self.refresh_timer.stop()
        
        # æ¸…é™¤token
        self.settings.remove("access_token")
        
        # å…³é—­å½“å‰çª—å£å¹¶æ˜¾ç¤ºç™»å½•çª—å£
        self.close()
        self.show_login()
```

#### 5. æ·»åŠ åˆ·æ–°é—´éš”è®¾ç½®

åœ¨ç³»ç»Ÿè®¾ç½®å¯¹è¯æ¡†ä¸­æ·»åŠ åˆ·æ–°é—´éš”è®¾ç½®ï¼š

```python
def show_settings_dialog(self):
    """æ˜¾ç¤ºç³»ç»Ÿè®¾ç½®å¯¹è¯æ¡†"""
    # åˆ›å»ºä¸€ä¸ªç®€å•çš„è®¾ç½®å¯¹è¯æ¡†
    dialog = QDialog(self)
    dialog.setWindowTitle("ç³»ç»Ÿè®¾ç½®")
    dialog.setMinimumWidth(400)
    
    layout = QVBoxLayout(dialog)
    
    # æ·»åŠ è®¾ç½®é€‰é¡¹
    form_layout = QFormLayout()
    
    # è‡ªåŠ¨åˆ·æ–°è®¾ç½®
    auto_refresh_check = QCheckBox("å¯ç”¨")
    auto_refresh_check.setChecked(self.refresh_timer.isActive())
    form_layout.addRow("è‡ªåŠ¨åˆ·æ–°:", auto_refresh_check)
    
    # åˆ·æ–°é—´éš”è®¾ç½®
    refresh_interval_spin = QSpinBox()
    refresh_interval_spin.setRange(10, 600)  # 10ç§’åˆ°10åˆ†é’Ÿ
    refresh_interval_spin.setSuffix(" ç§’")
    refresh_interval_spin.setValue(self.refresh_timer.interval() // 1000)
    form_layout.addRow("åˆ·æ–°é—´éš”:", refresh_interval_spin)
    
    layout.addLayout(form_layout)
    
    # æ·»åŠ æŒ‰é’®
    button_layout = QHBoxLayout()
    cancel_button = QPushButton("å–æ¶ˆ")
    cancel_button.clicked.connect(dialog.reject)
    
    save_button = QPushButton("ä¿å­˜")
    save_button.clicked.connect(dialog.accept)
    
    button_layout.addStretch()
    button_layout.addWidget(cancel_button)
    button_layout.addWidget(save_button)
    
    layout.addLayout(button_layout)
    
    # æ˜¾ç¤ºå¯¹è¯æ¡†
    if dialog.exec() == QDialog.DialogCode.Accepted:
        # ä¿å­˜è®¾ç½®
        if auto_refresh_check.isChecked():
            # å¯åŠ¨å®šæ—¶å™¨
            interval = refresh_interval_spin.value() * 1000  # è½¬æ¢ä¸ºæ¯«ç§’
            self.refresh_timer.setInterval(interval)
            self.refresh_timer.start()
        else:
            # åœæ­¢å®šæ—¶å™¨
            self.refresh_timer.stop()
        
        # ä¿å­˜è®¾ç½®åˆ°QSettings
        self.settings.setValue("auto_refresh", auto_refresh_check.isChecked())
        self.settings.setValue("refresh_interval", refresh_interval_spin.value() * 1000)
        
        QMessageBox.information(self, "è®¾ç½®å·²ä¿å­˜", "ç³»ç»Ÿè®¾ç½®å·²ä¿å­˜")
```

### æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨WebSocketå®ç°å®æ—¶æ›´æ–°ï¼ˆé«˜çº§æ–¹æ¡ˆï¼‰

è¿™ç§æ–¹æ¡ˆéœ€è¦åœ¨åç«¯å®ç°WebSocketæœåŠ¡ï¼Œå½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒæœåŠ¡å™¨ä¸»åŠ¨æ¨é€æ›´æ–°é€šçŸ¥ç»™å®¢æˆ·ç«¯ã€‚è¿™æ˜¯æœ€é«˜æ•ˆçš„å®æ—¶æ›´æ–°æ–¹æ¡ˆï¼Œä½†å®ç°å¤æ‚åº¦è¾ƒé«˜ã€‚

ç”±äºå½“å‰ç³»ç»Ÿæ¶æ„å¯èƒ½ä¸æ”¯æŒWebSocketï¼Œè¿™é‡Œä¸è¯¦ç»†å±•å¼€æ­¤æ–¹æ¡ˆã€‚å¦‚æœæœªæ¥éœ€è¦æ›´é«˜æ•ˆçš„å®æ—¶æ›´æ–°ï¼Œå¯ä»¥è€ƒè™‘å‡çº§ç³»ç»Ÿæ¶æ„ï¼Œå¼•å…¥WebSocketæ”¯æŒã€‚

## æ¨èå®æ–½æ–¹æ¡ˆ

è€ƒè™‘åˆ°ç³»ç»Ÿå½“å‰æ¶æ„å’Œå®æ–½éš¾åº¦ï¼Œæˆ‘æ¨èé‡‡ç”¨**æ–¹æ¡ˆä¸€ï¼šæ“ä½œåè‡ªåŠ¨è°ƒç”¨åˆ·æ–°æ–¹æ³•**ï¼Œå¹¶ç»“åˆ**æ–¹æ¡ˆäºŒï¼šæ·»åŠ è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨**çš„éƒ¨åˆ†åŠŸèƒ½ã€‚

### å…·ä½“å®æ–½æ­¥éª¤

1. åœ¨ä¸»çª—å£ä¸­æ·»åŠ å…¨å±€åˆ·æ–°æ–¹æ³•
2. ä¿®æ”¹å„ä¸ªè§†å›¾ä¸­çš„æ“ä½œæ–¹æ³•ï¼Œåœ¨æ“ä½œå®Œæˆåè‡ªåŠ¨è°ƒç”¨åˆ·æ–°æ–¹æ³•
3. æ·»åŠ è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨ï¼ˆå¯é€‰åŠŸèƒ½ï¼Œä½œä¸ºè¡¥å……ï¼‰
4. åœ¨ç³»ç»Ÿè®¾ç½®ä¸­æ·»åŠ è‡ªåŠ¨åˆ·æ–°ç›¸å…³é€‰é¡¹ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰

### å®æ–½ä¼˜å…ˆçº§

1. **é«˜ä¼˜å…ˆçº§**ï¼šåœ¨å„ä¸ªæ“ä½œæ–¹æ³•ä¸­æ·»åŠ è‡ªåŠ¨åˆ·æ–°è°ƒç”¨
2. **ä¸­ä¼˜å…ˆçº§**ï¼šæ·»åŠ å…¨å±€åˆ·æ–°æ–¹æ³•
3. **ä½ä¼˜å…ˆçº§**ï¼šæ·»åŠ è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨å’Œç›¸å…³è®¾ç½®

## æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½è€ƒè™‘**ï¼šé¢‘ç¹åˆ·æ–°å¯èƒ½ä¼šå½±å“ç³»ç»Ÿæ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨æ•°æ®é‡å¤§çš„æƒ…å†µä¸‹
2. **ç”¨æˆ·ä½“éªŒ**ï¼šåˆ·æ–°è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå¯¼è‡´ç•Œé¢çŸ­æš‚å¡é¡¿ï¼Œåº”æ·»åŠ é€‚å½“çš„è§†è§‰åé¦ˆ
3. **é”™è¯¯å¤„ç†**ï¼šè‡ªåŠ¨åˆ·æ–°è¿‡ç¨‹ä¸­çš„é”™è¯¯åº”è¯¥é™é»˜å¤„ç†ï¼Œé¿å…é¢‘ç¹å¼¹å‡ºé”™è¯¯å¯¹è¯æ¡†
4. **ç½‘ç»œè€ƒè™‘**ï¼šåœ¨ç½‘ç»œä¸ç¨³å®šçš„ç¯å¢ƒä¸­ï¼Œé¢‘ç¹åˆ·æ–°å¯èƒ½ä¼šå¯¼è‡´æ›´å¤šçš„ç½‘ç»œé”™è¯¯

## ä»£ç ç¤ºä¾‹ï¼šå…¨å±€åˆ·æ–°æŒ‰é’®å®ç°

é™¤äº†è‡ªåŠ¨åˆ·æ–°ï¼Œè¿˜å¯ä»¥åœ¨ä¸»çª—å£ä¸­æ·»åŠ ä¸€ä¸ªå…¨å±€åˆ·æ–°æŒ‰é’®ï¼Œè®©ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨è§¦å‘åˆ·æ–°ï¼š

```python
# åœ¨MainWindowçš„init_uiæ–¹æ³•ä¸­
# æ·»åŠ åˆ·æ–°æŒ‰é’®
refresh_action = QAction("ğŸ”„ åˆ·æ–°", self)
refresh_action.setToolTip("åˆ·æ–°å½“å‰è§†å›¾æ•°æ®")
refresh_action.triggered.connect(self.refresh_current_view)  # è¿æ¥åˆ°åˆ·æ–°æ–¹æ³•
quick_actions.addAction(refresh_action)
```

è¿™æ ·ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç‚¹å‡»åˆ·æ–°æŒ‰é’®æ‰‹åŠ¨åˆ·æ–°æ•°æ®ï¼ŒåŒæ—¶ç³»ç»Ÿä¹Ÿä¼šåœ¨å…³é”®æ“ä½œåè‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼Œç¡®ä¿æ•°æ®å§‹ç»ˆä¿æŒæœ€æ–°çŠ¶æ€ã€‚
