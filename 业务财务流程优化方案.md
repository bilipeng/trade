# 业务财务流程优化方案

## 当前流程分析

目前系统的业务财务流程大致如下：

1. **业务事件创建**：用户创建一个业务事件（如项目立项、采购申请等）
2. **审批流程**：业务事件提交审批，经过一个或多个审批人审批
3. **财务记录创建**：审批通过后，创建一条对应的财务记录
4. **流程结束**：业务事件状态变为"已入账"，流程结束

这种流程存在以下问题：

1. **一次性财务处理**：一个业务事件只能创建一条财务记录，不符合实际业务场景中可能需要多次消费记录的情况
2. **缺乏灵活性**：无法处理业务事件执行过程中产生的多次财务交易
3. **状态管理不完善**：业务事件一旦"已入账"就结束了，无法继续添加财务记录
4. **缺乏历史记录**：无法查看业务事件关联的所有财务记录历史

## 优化方案

### 方案一：多对一关系模型（推荐）

将业务事件与财务记录的关系从"一对一"改为"一对多"，即一个业务事件可以关联多条财务记录。

#### 数据库修改

1. 修改`financial_records`表，移除唯一约束（如果有）：

```sql
-- 创建新表（不修改现有表结构）
CREATE TABLE IF NOT EXISTS financial_transactions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    business_event_id INTEGER NOT NULL,         -- 关联的业务事件ID
    account_code TEXT NOT NULL,                 -- 会计科目编码
    account_name TEXT NOT NULL,                 -- 会计科目名称
    amount REAL NOT NULL,                       -- 金额
    direction TEXT NOT NULL,                    -- 方向：收入/支出
    transaction_date TEXT NOT NULL,             -- 交易日期
    fiscal_year INTEGER NOT NULL,               -- 财年
    fiscal_period INTEGER NOT NULL,             -- 会计期间
    description TEXT,                           -- 描述
    created_by INTEGER NOT NULL,                -- 创建人ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (business_event_id) REFERENCES business_events (id),
    FOREIGN KEY (created_by) REFERENCES users (id)
);
```

#### 业务状态流程修改

1. 修改业务事件状态流程：
   - "新建" → "待审批" → "已审批" → "执行中" → "已完成"
   - 在"执行中"状态下，可以添加多条财务记录
   - 只有在所有财务记录都添加完成后，才将状态改为"已完成"

2. 添加新的API端点：

```python
# 获取业务事件关联的所有财务记录
@app.get("/business_events/{event_id}/financial_records")
async def get_business_financial_records(event_id: int, current_user = Depends(get_current_user)):
    conn = get_db_connection()
    records = conn.execute("""
        SELECT * FROM financial_records 
        WHERE business_event_id = ?
        ORDER BY created_at DESC
    """, (event_id,)).fetchall()
    conn.close()
    return [dict(record) for record in records]

# 完成业务事件（标记为已完成）
@app.post("/business_events/{event_id}/complete")
async def complete_business_event(event_id: int, current_user = Depends(get_current_user)):
    # 检查用户权限
    if current_user["role"] not in ["财务人员", "管理员"]:
        raise HTTPException(status_code=403, detail="没有权限完成业务事件")
    
    conn = get_db_connection()
    cursor = conn.cursor()
    
    # 检查业务事件是否存在且状态为"执行中"
    event = cursor.execute("SELECT * FROM business_events WHERE id = ?", (event_id,)).fetchone()
    if not event:
        conn.close()
        raise HTTPException(status_code=404, detail="业务事件不存在")
    
    if dict(event)["status"] != "执行中":
        conn.close()
        raise HTTPException(status_code=400, detail="只有执行中的业务事件才能标记为已完成")
    
    # 检查是否有关联的财务记录
    records = cursor.execute("SELECT COUNT(*) as count FROM financial_records WHERE business_event_id = ?", 
                           (event_id,)).fetchone()
    if records["count"] == 0:
        conn.close()
        raise HTTPException(status_code=400, detail="业务事件至少需要一条财务记录才能标记为已完成")
    
    # 更新业务事件状态
    cursor.execute("UPDATE business_events SET status = '已完成' WHERE id = ?", (event_id,))
    
    conn.commit()
    conn.close()
    
    return {"message": "业务事件已标记为已完成"}
```

#### 前端界面修改

1. 修改财务记录管理界面，添加"业务事件详情"选项卡，显示业务事件的所有财务记录：

```python
def init_ui(self):
    """初始化UI"""
    # ... 现有代码 ...
    
    # 修改选项卡
    self.tabs = QTabWidget()
    self.tabs.addTab(self.create_pending_tab(), "待处理业务")
    self.tabs.addTab(self.create_records_tab(), "财务记录")
    self.tabs.addTab(self.create_business_detail_tab(), "业务事件详情")  # 新增选项卡
    
    main_layout.addWidget(self.tabs)

def create_business_detail_tab(self):
    """创建业务事件详情选项卡"""
    tab = QWidget()
    layout = QVBoxLayout(tab)
    
    # 顶部搜索区域
    top_layout = QHBoxLayout()
    top_layout.addWidget(QLabel("业务事件ID:"))
    
    self.business_id_input = QLineEdit()
    self.business_id_input.setPlaceholderText("输入业务事件ID")
    top_layout.addWidget(self.business_id_input)
    
    search_button = QPushButton("查询")
    search_button.clicked.connect(self.search_business_event)
    top_layout.addWidget(search_button)
    
    top_layout.addStretch()
    
    layout.addLayout(top_layout)
    
    # 业务事件信息区域
    self.business_info_group = QGroupBox("业务事件信息")
    self.business_info_group.setVisible(False)  # 初始不可见
    business_info_layout = QFormLayout(self.business_info_group)
    
    self.business_id_label = QLabel()
    business_info_layout.addRow("事件ID:", self.business_id_label)
    
    self.business_type_label = QLabel()
    business_info_layout.addRow("事件类型:", self.business_type_label)
    
    self.business_name_label = QLabel()
    business_info_layout.addRow("项目名称:", self.business_name_label)
    
    self.business_amount_label = QLabel()
    business_info_layout.addRow("金额:", self.business_amount_label)
    
    self.business_status_label = QLabel()
    business_info_layout.addRow("状态:", self.business_status_label)
    
    layout.addWidget(self.business_info_group)
    
    # 财务记录列表
    self.records_group = QGroupBox("关联的财务记录")
    self.records_group.setVisible(False)  # 初始不可见
    records_layout = QVBoxLayout(self.records_group)
    
    # 添加财务记录按钮
    add_record_layout = QHBoxLayout()
    add_record_layout.addStretch()
    
    self.add_record_button = QPushButton("添加财务记录")
    self.add_record_button.clicked.connect(self.add_financial_record)
    add_record_layout.addWidget(self.add_record_button)
    
    self.complete_button = QPushButton("标记为已完成")
    self.complete_button.clicked.connect(self.complete_business_event)
    add_record_layout.addWidget(self.complete_button)
    
    records_layout.addLayout(add_record_layout)
    
    # 财务记录表格
    self.records_table = QTableWidget()
    self.records_table.setColumnCount(7)
    self.records_table.setHorizontalHeaderLabels(["ID", "科目", "金额", "方向", "交易日期", "描述", "操作"])
    self.records_table.horizontalHeader().setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
    records_layout.addWidget(self.records_table)
    
    layout.addWidget(self.records_group)
    
    return tab
```

2. 添加相关方法：

```python
def search_business_event(self):
    """查询业务事件"""
    business_id = self.business_id_input.text().strip()
    if not business_id:
        QMessageBox.warning(self, "输入错误", "请输入业务事件ID")
        return
    
    try:
        # 获取业务事件详情
        response = requests.get(
            f"http://localhost:8000/business_events/{business_id}",
            headers={"Authorization": f"Bearer {self.token}"}
        )
        
        if response.status_code == 200:
            event_data = response.json()
            
            # 显示业务事件信息
            self.business_id_label.setText(str(event_data["id"]))
            self.business_type_label.setText(event_data["event_type"])
            self.business_name_label.setText(event_data["project_name"])
            self.business_amount_label.setText(f"¥{event_data['amount']:,.2f}")
            self.business_status_label.setText(event_data["status"])
            
            # 显示业务事件信息区域
            self.business_info_group.setVisible(True)
            
            # 加载关联的财务记录
            self.load_business_financial_records(business_id)
            
            # 根据业务事件状态控制按钮可用性
            self.add_record_button.setEnabled(event_data["status"] in ["已审批", "执行中"])
            self.complete_button.setEnabled(event_data["status"] == "执行中")
        else:
            QMessageBox.warning(self, "查询失败", "无法获取业务事件详情")
    except Exception as e:
        QMessageBox.warning(self, "错误", f"查询业务事件时发生错误: {str(e)}")

def load_business_financial_records(self, business_id):
    """加载业务事件关联的财务记录"""
    try:
        response = requests.get(
            f"http://localhost:8000/business_events/{business_id}/financial_records",
            headers={"Authorization": f"Bearer {self.token}"}
        )
        
        if response.status_code == 200:
            records = response.json()
            
            # 显示财务记录表格
            self.records_table.setRowCount(0)
            
            for row, record in enumerate(records):
                self.records_table.insertRow(row)
                
                self.records_table.setItem(row, 0, QTableWidgetItem(str(record["id"])))
                self.records_table.setItem(row, 1, QTableWidgetItem(f"{record['account_code']} - {record['account_name']}"))
                self.records_table.setItem(row, 2, QTableWidgetItem(f"¥{record['amount']:,.2f}"))
                self.records_table.setItem(row, 3, QTableWidgetItem(record["direction"]))
                self.records_table.setItem(row, 4, QTableWidgetItem(record["transaction_date"]))
                self.records_table.setItem(row, 5, QTableWidgetItem(record["description"] if record["description"] else ""))
                
                # 操作按钮
                btn_widget = QWidget()
                btn_layout = QHBoxLayout(btn_widget)
                btn_layout.setContentsMargins(2, 2, 2, 2)
                
                detail_btn = QPushButton("详情")
                detail_btn.clicked.connect(lambda _, r_id=record["id"]: self.show_record_detail(r_id))
                btn_layout.addWidget(detail_btn)
                
                self.records_table.setCellWidget(row, 6, btn_widget)
            
            # 显示财务记录区域
            self.records_group.setVisible(True)
        else:
            QMessageBox.warning(self, "查询失败", "无法获取财务记录")
    except Exception as e:
        QMessageBox.warning(self, "错误", f"加载财务记录时发生错误: {str(e)}")

def add_financial_record(self):
    """添加财务记录"""
    business_id = self.business_id_label.text()
    if not business_id:
        QMessageBox.warning(self, "操作错误", "请先查询业务事件")
        return
    
    # 获取业务事件详情
    try:
        response = requests.get(
            f"http://localhost:8000/business_events/{business_id}",
            headers={"Authorization": f"Bearer {self.token}"}
        )
        
        if response.status_code == 200:
            event_data = response.json()
            
            # 如果状态是"已审批"，先更新为"执行中"
            if event_data["status"] == "已审批":
                status_response = requests.post(
                    f"http://localhost:8000/business_events/{business_id}/status",
                    json={"status": "执行中"},
                    headers={"Authorization": f"Bearer {self.token}"}
                )
                
                if status_response.status_code != 200:
                    QMessageBox.warning(self, "状态更新失败", "无法更新业务事件状态")
                    return
            
            # 打开财务记录创建对话框
            dialog = FinancialRecordDialog(self.token, self.user_data, 
                                         self.account_subjects, [event_data], 
                                         preselect_business=int(business_id))
            if dialog.exec() == QDialog.DialogCode.Accepted:
                # 刷新财务记录列表
                self.load_business_financial_records(business_id)
        else:
            QMessageBox.warning(self, "查询失败", "无法获取业务事件详情")
    except Exception as e:
        QMessageBox.warning(self, "错误", f"添加财务记录时发生错误: {str(e)}")

def complete_business_event(self):
    """标记业务事件为已完成"""
    business_id = self.business_id_label.text()
    if not business_id:
        QMessageBox.warning(self, "操作错误", "请先查询业务事件")
        return
    
    reply = QMessageBox.question(
        self, '确认操作', 
        "确定要将此业务事件标记为已完成吗？完成后将不能再添加财务记录。", 
        QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No, 
        QMessageBox.StandardButton.No
    )
    
    if reply == QMessageBox.StandardButton.Yes:
        try:
            response = requests.post(
                f"http://localhost:8000/business_events/{business_id}/complete",
                headers={"Authorization": f"Bearer {self.token}"}
            )
            
            if response.status_code == 200:
                QMessageBox.information(self, "操作成功", "业务事件已标记为已完成")
                
                # 刷新业务事件信息
                self.search_business_event()
            else:
                QMessageBox.warning(self, "操作失败", f"标记业务事件为已完成失败: {response.text}")
        except Exception as e:
            QMessageBox.warning(self, "错误", f"操作时发生错误: {str(e)}")
```

### 方案二：使用交易批次概念

如果业务场景更复杂，可以引入"交易批次"的概念，将一个业务事件分为多个交易批次，每个批次可以包含多条财务记录。

#### 数据库修改

```sql
-- 交易批次表
CREATE TABLE IF NOT EXISTS transaction_batches (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    business_event_id INTEGER NOT NULL,         -- 关联的业务事件ID
    batch_name TEXT NOT NULL,                   -- 批次名称
    batch_date TEXT NOT NULL,                   -- 批次日期
    status TEXT NOT NULL DEFAULT '进行中',       -- 状态：进行中/已完成
    description TEXT,                           -- 描述
    created_by INTEGER NOT NULL,                -- 创建人ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (business_event_id) REFERENCES business_events (id),
    FOREIGN KEY (created_by) REFERENCES users (id)
);

-- 修改财务记录表，添加批次ID字段
CREATE TABLE IF NOT EXISTS financial_transactions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    batch_id INTEGER NOT NULL,                  -- 关联的交易批次ID
    account_code TEXT NOT NULL,                 -- 会计科目编码
    account_name TEXT NOT NULL,                 -- 会计科目名称
    amount REAL NOT NULL,                       -- 金额
    direction TEXT NOT NULL,                    -- 方向：收入/支出
    transaction_date TEXT NOT NULL,             -- 交易日期
    fiscal_year INTEGER NOT NULL,               -- 财年
    fiscal_period INTEGER NOT NULL,             -- 会计期间
    description TEXT,                           -- 描述
    created_by INTEGER NOT NULL,                -- 创建人ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (batch_id) REFERENCES transaction_batches (id),
    FOREIGN KEY (created_by) REFERENCES users (id)
);
```

这种方案更适合复杂的业务场景，但实现起来也更复杂，需要更多的界面和逻辑来管理交易批次。

## 实施建议

考虑到系统当前的复杂度和用户需求，我建议采用**方案一**，将业务事件与财务记录的关系改为"一对多"。这种方案实现相对简单，但能满足大多数业务场景的需求。

### 实施步骤

1. **数据库修改**：
   - 创建新的财务交易表（不修改现有表结构）
   - 添加新的API端点

2. **业务流程修改**：
   - 修改业务事件状态流程，添加"执行中"状态
   - 实现业务事件完成功能

3. **前端界面修改**：
   - 添加"业务事件详情"选项卡
   - 实现查询业务事件、显示关联财务记录的功能
   - 实现添加多条财务记录的功能
   - 实现标记业务事件为已完成的功能

4. **测试与优化**：
   - 测试新的业务流程
   - 收集用户反馈
   - 根据反馈进行优化

## 预期效果

实施这些改进后，系统将能够支持更灵活的业务财务流程：

1. 一个业务事件可以关联多条财务记录
2. 用户可以根据实际情况分多次添加财务记录
3. 业务事件的状态更加清晰，从"新建"到"已完成"有明确的流转过程
4. 用户可以查看业务事件关联的所有财务记录历史

这种改进将使系统更加符合实际业务场景，提高用户体验和系统实用性。
