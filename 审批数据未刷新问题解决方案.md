# 审批数据未刷新问题解决方案

## 问题描述

在业财融合管理系统中，当用户在业务数据中选择一条待审批的数据，点击"提交审批"按钮后，系统成功将业务事件提交到审批流程，但切换到审批管理界面时，却看不到需要审批的这条数据。这表明审批数据没有正确刷新或加载。

## 问题原因分析

通过代码分析，发现可能的原因如下：

1. **API端点限制**：
   在 `server/app.py` 中的 `/approvals` API端点有两个关键限制：
   ```python
   @app.get("/approvals")
   async def get_approvals(current_user = Depends(get_current_user)):
       conn = get_db_connection()
       approvals = conn.execute("""
           SELECT a.*, be.project_name, be.event_type, be.amount, u.username as approver_name
           FROM approvals a
           JOIN business_events be ON a.business_event_id = be.id
           JOIN users u ON a.approver_id = u.id
           WHERE a.approver_id = ? AND a.status = '待审批'
           ORDER BY a.created_at DESC
       """, (current_user["id"],)).fetchall()
       conn.close()
       return [dict(approval) for approval in approvals]
   ```

   这个API有两个重要限制：
   - 只返回当前登录用户是审批人的记录（`approver_id = current_user["id"]`）
   - 只返回状态为"待审批"的记录（已处理的审批不会显示）

2. **审批配置问题**：
   当前登录用户可能没有在 `approval_configs` 表中配置审批权限。例如，如果您创建了一个"销售"类型的业务事件，但当前用户在 `approval_configs` 表中没有对应的"销售"类型审批配置，那么系统不会为该用户创建审批任务。

3. **部门匹配问题**：
   审批配置是基于事件类型和部门ID的。如果业务事件的部门ID与审批配置中的部门ID不匹配，也不会创建审批任务。

4. **金额阈值问题**：
   审批配置中有金额阈值设置，只有当业务事件金额超过或等于阈值时，才会创建对应级别的审批任务。

5. **审批流程创建失败**：
   在提交审批时，可能由于某些原因导致审批流程创建失败，但前端没有正确处理这种情况。

## 解决方案

### 方案一：检查并修复审批配置（推荐）

1. 检查当前用户是否有对应的审批配置：

```sql
-- 在SQLite命令行或管理工具中执行
SELECT * FROM approval_configs WHERE approver_id = 当前用户ID;
```

2. 如果没有，添加适当的审批配置：

```sql
INSERT INTO approval_configs (event_type, department_id, approver_id, approval_level, amount_threshold, is_active)
VALUES ('销售', 业务事件的部门ID, 当前用户ID, 1, 0.00, 1);
```

3. 确保业务事件的部门ID与审批配置中的部门ID匹配：

```sql
-- 查看业务事件的部门ID
SELECT id, event_type, project_name, department_id FROM business_events WHERE id = 业务事件ID;

-- 查看审批配置中的部门ID
SELECT * FROM approval_configs WHERE event_type = '业务事件类型';
```

### 方案二：修改审批API端点

如果您希望查看所有审批记录，而不仅仅是分配给当前用户的记录，可以修改 `/approvals` API端点：

1. 打开 `server/app.py` 文件
2. 找到 `@app.get("/approvals")` 函数
3. 修改为：

```python
@app.get("/approvals")
async def get_approvals(current_user = Depends(get_current_user)):
    conn = get_db_connection()
    
    # 管理员可以查看所有审批
    if current_user["role"] == "管理员":
        approvals = conn.execute("""
            SELECT a.*, be.project_name, be.event_type, be.amount, u.username as approver_name
            FROM approvals a
            JOIN business_events be ON a.business_event_id = be.id
            JOIN users u ON a.approver_id = u.id
            ORDER BY a.created_at DESC
        """).fetchall()
    else:
        # 普通用户只能查看自己的待审批记录
        approvals = conn.execute("""
            SELECT a.*, be.project_name, be.event_type, be.amount, u.username as approver_name
            FROM approvals a
            JOIN business_events be ON a.business_event_id = be.id
            JOIN users u ON a.approver_id = u.id
            WHERE a.approver_id = ? AND a.status = '待审批'
            ORDER BY a.created_at DESC
        """, (current_user["id"],)).fetchall()
    
    conn.close()
    return [dict(approval) for approval in approvals]
```

### 方案三：添加调试输出和错误处理

在提交审批和加载审批数据的过程中添加调试输出，帮助定位问题：

1. 在 `client/views/business_view.py` 的 `submit_to_approval` 方法中添加调试输出：

```python
def submit_to_approval(self, business_id):
    """提交业务事件至审批流程"""
    try:
        print(f"提交业务事件 {business_id} 到审批流程")
        
        # 调用新API将业务事件提交到审批流程
        response = requests.post(
            f"http://localhost:8000/business_events/{business_id}/submit-to-approval",
            headers={"Authorization": f"Bearer {self.token}"}
        )
        
        print(f"响应状态码: {response.status_code}")
        print(f"响应内容: {response.text}")
        
        if response.status_code == 200:
            QMessageBox.information(self, "提交成功", "业务事件已成功提交到审批流程")
            self.load_data()  # 刷新数据
        else:
            QMessageBox.warning(self, "提交失败", f"提交到审批流程失败: {response.text}")
    except Exception as e:
        print(f"提交过程中发生错误: {str(e)}")
        QMessageBox.warning(self, "错误", f"提交过程中发生错误: {str(e)}")
```

2. 在 `client/views/approval_view.py` 的 `load_data` 方法中添加调试输出：

```python
def load_data(self):
    """加载审批数据"""
    try:
        print(f"当前用户: {self.user_data}")  # 打印当前用户信息
        
        response = requests.get(
            "http://localhost:8000/approvals",
            headers={"Authorization": f"Bearer {self.token}"}
        )
        
        print(f"响应状态码: {response.status_code}")  # 打印响应状态码
        print(f"响应内容: {response.text}")  # 打印响应内容
        
        if response.status_code == 200:
            self.data = response.json()
            print(f"解析后的数据: {self.data}")  # 打印解析后的数据
            print(f"数据长度: {len(self.data)}")  # 打印数据长度
            self.display_data()
        else:
            QMessageBox.warning(self, "加载失败", "无法加载审批数据")
    except Exception as e:
        print(f"加载审批数据时发生错误: {str(e)}")
        QMessageBox.warning(self, "错误", f"加载审批数据时发生错误: {str(e)}")
```

3. 在 `server/app.py` 的 `/business_events/{event_id}/submit-to-approval` 端点中添加调试输出：

```python
@app.post("/business_events/{event_id}/submit-to-approval")
async def submit_to_approval(event_id: int, current_user = Depends(get_current_user)):
    print(f"提交业务事件 {event_id} 到审批流程，用户: {current_user['username']}")
    
    conn = get_db_connection()
    cursor = conn.cursor()
    
    # 检查业务事件是否存在
    event = cursor.execute("SELECT * FROM business_events WHERE id = ?", (event_id,)).fetchone()
    if not event:
        conn.close()
        print(f"业务事件 {event_id} 不存在")
        raise HTTPException(status_code=404, detail="业务事件不存在")
    
    event_data = dict(event)
    print(f"业务事件数据: {event_data}")
    
    # 检查当前状态是否允许提交审批
    if event_data["status"] not in ["新建", "待审批"]:
        conn.close()
        print(f"业务事件状态 {event_data['status']} 不允许提交审批")
        raise HTTPException(status_code=400, detail="当前状态不允许提交审批")
    
    # 创建审批任务（如果尚未创建）
    existing_approvals = cursor.execute(
        "SELECT COUNT(*) as count FROM approvals WHERE business_event_id = ?", 
        (event_id,)
    ).fetchone()
    
    print(f"现有审批数量: {existing_approvals['count']}")
    
    if existing_approvals["count"] == 0:
        # 查询匹配的审批配置
        configs = cursor.execute("""
            SELECT * FROM approval_configs
            WHERE event_type = ? AND department_id = ? AND is_active = 1
            AND (amount_threshold IS NULL OR amount_threshold <= ?)
            ORDER BY approval_level
        """, (event_data["event_type"], event_data["department_id"], event_data["amount"])).fetchall()
        
        print(f"匹配的审批配置数量: {len(configs)}")
        
        if len(configs) == 0:
            print("警告: 没有找到匹配的审批配置")
        
        # 创建审批流程
        for config in configs:
            print(f"创建审批任务: 审批人ID={config['approver_id']}, 级别={config['approval_level']}")
            cursor.execute("""
                INSERT INTO approvals (business_event_id, approver_id, approval_level, status)
                VALUES (?, ?, ?, '待审批')
            """, (event_id, config["approver_id"], config["approval_level"]))
    
    # 更新业务事件状态
    cursor.execute(
        "UPDATE business_events SET status = '待审批' WHERE id = ?",
        (event_id,)
    )
    
    conn.commit()
    conn.close()
    
    return {"message": "业务事件已成功提交到审批流程"}
```

### 方案四：添加手动刷新按钮

在审批管理界面添加一个明显的刷新按钮，让用户可以手动刷新审批数据：

1. 在 `client/views/approval_view.py` 的 `init_ui` 方法中添加刷新按钮：

```python
# 刷新按钮
refresh_button = QPushButton("刷新审批数据")
refresh_button.setProperty("class", "primary")
refresh_button.clicked.connect(self.refresh_data)
top_layout.addWidget(refresh_button)
```

2. 确保 `refresh_data` 方法正确实现：

```python
def refresh_data(self):
    """刷新数据"""
    self.load_data()
    QMessageBox.information(self, "刷新成功", "审批数据已刷新")
```

## 实施步骤总结

1. 首先检查审批配置，确保当前用户有对应的审批权限
2. 如果需要，修改审批API端点，允许查看更多审批记录
3. 添加调试输出，帮助定位具体问题
4. 添加手动刷新按钮，提高用户体验
5. 测试提交审批和查看审批流程，确认问题已解决

## 注意事项

- 审批配置是基于事件类型、部门ID和金额阈值的，确保这些参数匹配
- 用户角色和权限会影响审批流程的创建和查看
- 如果修改了API端点，需要重启后端服务
- 调试输出可能会泄露敏感信息，在问题解决后应移除
