# 图表优化指南

本文档提供了针对业财看板中图表的优化方案，主要解决以下问题：
1. 折线图数据不准确
2. 饼状图没有显示名称
3. 将图表中的英文改为中文

## 1. 折线图数据优化

### 1.1 修改折线图数据源

在`dashboard.py`文件中，找到创建折线图的方法（可能命名为`createTrendChart`或类似名称），修改数据源和数据处理逻辑：

```python
def createTrendChart(self, data):
    """创建趋势折线图"""
    # 清除之前的图表
    self.trend_figure.clear()
    
    # 创建子图
    ax = self.trend_figure.add_subplot(111)
    
    # 准备数据 - 确保数据准确性
    dates = data.get("dates", [])
    values = data.get("values", [])
    
    # 数据验证和清洗
    if len(dates) != len(values):
        print("警告：日期和值的数量不匹配")
        # 确保两个列表长度一致
        min_length = min(len(dates), len(values))
        dates = dates[:min_length]
        values = values[:min_length]
    
    # 确保日期格式正确
    formatted_dates = []
    for date_str in dates:
        try:
            # 尝试解析日期
            date_obj = datetime.strptime(date_str, "%Y-%m-%d")
            formatted_dates.append(date_obj)
        except ValueError:
            print(f"警告：无效的日期格式 '{date_str}'")
            # 使用当前日期作为替代
            formatted_dates.append(datetime.now())
    
    # 绘制折线图
    ax.plot(formatted_dates, values, marker='o', linestyle='-', color='#1976D2', linewidth=2, markersize=6)
    
    # 设置图表属性
    ax.set_xlabel('日期', fontsize=10)
    ax.set_ylabel('金额（元）', fontsize=10)
    ax.set_title('资金趋势', fontsize=12, fontweight='bold')
    
    # 设置x轴日期格式
    import matplotlib.dates as mdates
    ax.xaxis.set_major_formatter(mdates.DateFormatter('%m-%d'))
    ax.xaxis.set_major_locator(mdates.DayLocator(interval=max(1, len(dates)//5)))  # 自动调整间隔
    
    # 添加网格线
    ax.grid(True, linestyle='--', alpha=0.7)
    
    # 旋转日期标签，避免重叠
    plt.setp(ax.get_xticklabels(), rotation=45, ha='right')
    
    # 添加数据标签
    for i, (date, value) in enumerate(zip(formatted_dates, values)):
        ax.annotate(f'{value:,.0f}', 
                   (date, value),
                   textcoords="offset points", 
                   xytext=(0, 10), 
                   ha='center',
                   fontsize=8)
    
    # 自动调整布局
    self.trend_figure.tight_layout()
    
    # 刷新画布
    self.trend_canvas.draw()
```

### 1.2 修改数据获取逻辑

确保从API获取的数据是准确的：

```python
def loadTrendData(self):
    """加载趋势数据"""
    try:
        # 从主窗口获取token
        token = self.parent().token if self.parent() and hasattr(self.parent(), 'token') else None
        headers = {"Authorization": f"Bearer {token}"} if token else {}
        
        # 获取最近30天的数据
        end_date = datetime.now()
        start_date = end_date - timedelta(days=30)
        
        # API请求
        response = requests.get(
            f"http://localhost:8000/api/financial/trend?start_date={start_date.strftime('%Y-%m-%d')}&end_date={end_date.strftime('%Y-%m-%d')}",
            headers=headers
        )
        
        if response.status_code == 200:
            data = response.json()
            self.createTrendChart(data)
        else:
            print(f"获取趋势数据失败: {response.status_code}")
            # 使用模拟数据
            self.createTrendChart(self.generateMockTrendData())
    except Exception as e:
        print(f"加载趋势数据异常: {str(e)}")
        # 使用模拟数据
        self.createTrendChart(self.generateMockTrendData())

def generateMockTrendData(self):
    """生成模拟趋势数据"""
    # 生成最近30天的日期
    end_date = datetime.now()
    dates = [(end_date - timedelta(days=i)).strftime("%Y-%m-%d") for i in range(30, 0, -1)]
    
    # 生成合理的趋势数据
    base_value = 1000000  # 基础值
    values = []
    for i in range(30):
        # 添加一些随机波动，但保持整体趋势
        random_factor = random.uniform(0.95, 1.05)
        trend_factor = 1 + (i * 0.01)  # 轻微上升趋势
        value = base_value * random_factor * trend_factor
        values.append(round(value, 2))
    
    return {
        "dates": dates,
        "values": values
    }
```

## 2. 饼状图名称显示问题

### 2.1 修改饼状图创建方法

在`dashboard.py`文件中，找到创建饼状图的方法，修改如下：

```python
def createPieChart(self, data):
    """创建饼状图"""
    # 清除之前的图表
    self.pie_figure.clear()
    
    # 创建子图
    ax = self.pie_figure.add_subplot(111)
    
    # 准备数据
    labels = data.get("labels", [])
    values = data.get("values", [])
    
    # 数据验证
    if len(labels) != len(values):
        print("警告：标签和值的数量不匹配")
        min_length = min(len(labels), len(values))
        labels = labels[:min_length]
        values = values[:min_length]
    
    # 确保所有值都是正数
    values = [max(0, v) for v in values]
    
    # 如果没有数据，添加一个占位符
    if not values or sum(values) == 0:
        labels = ["暂无数据"]
        values = [1]
    
    # 设置颜色
    colors = ['#1976D2', '#4CAF50', '#FF9800', '#E91E63', '#9C27B0', '#00BCD4', '#FFEB3B', '#795548']
    
    # 确保颜色足够
    while len(colors) < len(labels):
        colors.extend(colors)
    
    # 绘制饼图
    wedges, texts, autotexts = ax.pie(
        values, 
        labels=None,  # 先不显示标签
        autopct='%1.1f%%', 
        startangle=90, 
        colors=colors[:len(labels)],
        wedgeprops={'edgecolor': 'w', 'linewidth': 1},
        textprops={'fontsize': 10}
    )
    
    # 设置标签和百分比的字体
    for autotext in autotexts:
        autotext.set_fontsize(9)
    
    # 添加图例，显示标签
    ax.legend(
        wedges, 
        labels, 
        title="分类", 
        loc="center left", 
        bbox_to_anchor=(1, 0, 0.5, 1),
        fontsize=9
    )
    
    # 设置标题
    ax.set_title('资金分布', fontsize=12, fontweight='bold')
    
    # 等比例显示
    ax.axis('equal')
    
    # 自动调整布局
    self.pie_figure.tight_layout()
    
    # 刷新画布
    self.pie_canvas.draw()
```

### 2.2 修改数据获取逻辑

确保饼图数据包含正确的标签：

```python
def loadPieData(self):
    """加载饼图数据"""
    try:
        # 从主窗口获取token
        token = self.parent().token if self.parent() and hasattr(self.parent(), 'token') else None
        headers = {"Authorization": f"Bearer {token}"} if token else {}
        
        # API请求
        response = requests.get(
            "http://localhost:8000/api/financial/distribution",
            headers=headers
        )
        
        if response.status_code == 200:
            data = response.json()
            self.createPieChart(data)
        else:
            print(f"获取分布数据失败: {response.status_code}")
            # 使用模拟数据
            self.createPieChart(self.generateMockPieData())
    except Exception as e:
        print(f"加载分布数据异常: {str(e)}")
        # 使用模拟数据
        self.createPieChart(self.generateMockPieData())

def generateMockPieData(self):
    """生成模拟饼图数据"""
    return {
        "labels": ["销售收入", "采购支出", "人力成本", "运营费用", "研发投入"],
        "values": [500000, 300000, 200000, 150000, 100000]
    }
```

## 3. 将图表英文改为中文

### 3.1 设置matplotlib全局字体

在`dashboard.py`文件的顶部导入部分添加以下代码：

```python
# 设置matplotlib中文支持
import matplotlib.pyplot as plt
import matplotlib as mpl

# 设置中文字体
try:
    # 尝试设置中文字体
    plt.rcParams['font.sans-serif'] = ['SimHei', 'Microsoft YaHei', 'SimSun', 'Arial Unicode MS']
    plt.rcParams['axes.unicode_minus'] = False  # 解决负号显示问题
    
    # 验证字体是否可用
    mpl.font_manager._rebuild()
except Exception as e:
    print(f"设置中文字体失败: {str(e)}")
```

### 3.2 修改所有图表中的英文文本

#### 3.2.1 柱状图

```python
def createProgressChart(self, data):
    """创建项目进度图表"""
    # 清除之前的图表
    self.progress_figure.clear()
    
    # 创建子图
    ax = self.progress_figure.add_subplot(111)
    
    # 设置数据
    names = data["names"]
    planned = data["planned_progress"]
    actual = data["actual_progress"]
    
    # 设置柱状图位置
    x = range(len(names))
    width = 0.35
    
    # 绘制柱状图
    ax.bar([i - width/2 for i in x], planned, width, label='计划进度', color='#1976D2')
    ax.bar([i + width/2 for i in x], actual, width, label='实际进度', color='#4CAF50')
    
    # 设置图表属性
    ax.set_ylabel('进度 (%)', fontsize=10)
    ax.set_title('项目进度对比', fontsize=12, fontweight='bold')
    ax.set_xticks(x)
    ax.set_xticklabels(names, fontsize=9)
    ax.legend(frameon=True, fontsize=9)
    
    # 添加数据标签
    for i, v in enumerate(planned):
        ax.text(i - width/2, v + 2, str(v), ha='center', va='bottom', fontsize=8)
    for i, v in enumerate(actual):
        ax.text(i + width/2, v + 2, str(v), ha='center', va='bottom', fontsize=8)
    
    # 刷新画布
    self.progress_canvas.draw()
```

#### 3.2.2 预算图表

```python
def createBudgetChart(self, data):
    """创建预算执行图表"""
    # 清除之前的图表
    self.budget_figure.clear()
    
    # 创建子图
    ax = self.budget_figure.add_subplot(111)
    
    # 设置数据
    names = data["names"]
    budget = data["budget"]
    spent = data["spent"]
    
    # 设置柱状图位置
    x = range(len(names))
    width = 0.35
    
    # 绘制柱状图
    ax.bar([i - width/2 for i in x], budget, width, label='预算金额', color='#1976D2')
    ax.bar([i + width/2 for i in x], spent, width, label='已用金额', color='#FF9800')
    
    # 设置图表属性
    ax.set_ylabel('金额 (元)', fontsize=10)
    ax.set_title('预算执行情况', fontsize=12, fontweight='bold')
    ax.set_xticks(x)
    ax.set_xticklabels(names, fontsize=9)
    ax.legend(frameon=True, fontsize=9)
    
    # 添加数据标签
    for i, v in enumerate(budget):
        ax.text(i - width/2, v + 5000, f"{v/10000:.1f}万", ha='center', va='bottom', fontsize=8)
    for i, v in enumerate(spent):
        ax.text(i + width/2, v + 5000, f"{v/10000:.1f}万", ha='center', va='bottom', fontsize=8)
    
    # 刷新画布
    self.budget_canvas.draw()
```

## 4. 解决中文显示问题的备选方案

如果上述方法无法解决中文显示问题，可以尝试以下备选方案：

### 4.1 使用系统字体

```python
import matplotlib.font_manager as fm

# 查找系统中可用的中文字体
chinese_fonts = []
for f in fm.fontManager.ttflist:
    if 'chinese' in f.name.lower() or '黑体' in f.name or '宋体' in f.name or '微软雅黑' in f.name:
        chinese_fonts.append(f.name)

print("可用的中文字体:", chinese_fonts)

# 使用找到的第一个中文字体
if chinese_fonts:
    plt.rcParams['font.sans-serif'] = [chinese_fonts[0]] + plt.rcParams['font.sans-serif']
```

### 4.2 手动添加字体文件

```python
import matplotlib.font_manager as fm

# 添加字体文件
font_path = 'path/to/your/chinese/font.ttf'  # 替换为实际字体路径
fm.fontManager.addfont(font_path)
plt.rcParams['font.sans-serif'] = ['your_font_name'] + plt.rcParams['font.sans-serif']
```

### 4.3 使用图片标签代替文字

如果中文字体问题无法解决，可以考虑使用图片标签：

```python
def createPieChart(self, data):
    # ... 其他代码保持不变
    
    # 不使用内置标签，而是手动添加
    wedges, _, autotexts = ax.pie(
        values, 
        labels=None,
        autopct='%1.1f%%', 
        startangle=90, 
        colors=colors[:len(labels)]
    )
    
    # 手动添加图例
    ax.legend(
        wedges, 
        labels, 
        title="分类", 
        loc="center left", 
        bbox_to_anchor=(1, 0, 0.5, 1)
    )
```

## 5. 实施步骤

1. 首先备份当前的`dashboard.py`文件
2. 添加中文字体支持代码
3. 修改折线图数据源和处理逻辑
4. 修改饼图创建方法，确保正确显示标签
5. 将所有图表中的英文文本替换为中文
6. 测试各个图表，确保数据准确性和中文显示正常

## 6. 注意事项

1. 中文字体问题可能与操作系统有关，Windows、macOS和Linux系统可能需要不同的配置
2. 如果使用PyInstaller打包应用，需要确保中文字体文件被正确包含
3. 数据验证和清洗非常重要，可以避免因数据问题导致的图表显示异常
4. 对于大量数据，考虑使用数据聚合或采样，以提高图表渲染性能
5. 图表颜色应保持一致性，建议定义全局颜色变量

## 7. 调试技巧

如果遇到图表显示问题，可以添加以下调试代码：

```python
# 在dashboard.py顶部添加
import logging
logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

# 在图表创建方法中添加日志
logger.debug(f"创建图表，数据: {data}")

# 检查matplotlib字体
import matplotlib.font_manager as fm
logger.debug(f"当前字体: {plt.rcParams['font.sans-serif']}")
logger.debug(f"可用字体: {[f.name for f in fm.fontManager.ttflist][:10]}")  # 只显示前10个
```

这些修改将解决折线图数据不准确、饼状图没有显示名称，以及将图表中的英文改为中文的问题，使您的业财看板更加美观和易于理解。
