# 系统错误修复指南

## 问题描述

系统启动时出现两个主要错误：

1. **客户端错误**：
   ```
   ImportError: DLL load failed while importing QtWebEngineWidgets: 找不到指定的程序。
   ```

2. **服务器端错误**：
   ```
   NameError: name 'app' is not defined
   ```

## 错误原因分析

### 1. 客户端错误

客户端错误是由于缺少PyQt6的WebEngine组件导致的。`QWebEngineView`类用于在应用程序中显示网页内容，但系统中缺少相关的DLL文件。

### 2. 服务器端错误

服务器端错误是由于`api_endpoints.py`文件中直接使用了`app`变量，但该变量未在文件中定义。这是因为`api_endpoints.py`文件被设计为FastAPI应用程序的一部分，但实际上应该是Flask应用程序的蓝图。

## 修复方案

### 1. 客户端修复

#### 方案A：安装WebEngine组件

```bash
pip install PyQt6-WebEngine
```

#### 方案B：替代WebEngine（已实施）

修改`dashboard.py`文件，使用简单的QLabel替代QWebEngineView：

1. 注释掉WebEngine导入：
   ```python
   # from PyQt6.QtWebEngineWidgets import QWebEngineView
   ```

2. 使用QLabel替代图表显示：
   ```python
   # 创建一个简单的标签来代替图表
   chart_label = QLabel("项目进度对比图表 - QWebEngineView不可用")
   chart_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
   chart_label.setStyleSheet("background-color: #f0f0f0; padding: 20px; font-size: 16px;")
   chart_label.setMinimumHeight(300)
   self.chart_layout.addWidget(chart_label)
   ```

### 2. 服务器端修复

将`api_endpoints.py`文件从FastAPI风格转换为Flask蓝图风格：

1. 添加Flask蓝图定义：
   ```python
   from flask import Blueprint, jsonify, request, g
   import sqlite3
   import os
   from datetime import datetime

   api = Blueprint('api', __name__)
   ```

2. 修改路由装饰器：
   ```python
   # 修改前
   @app.get("/api/projects/stats")
   async def get_project_stats(current_user = Depends(get_current_user)):
   
   # 修改后
   @api.route('/projects/stats', methods=['GET'])
   def get_project_stats():
   ```

3. 修改返回值格式：
   ```python
   # 修改前
   return {
       "total_projects": 12,
       "total_budget": 1500000.00,
       "completed_projects": 5,
       "in_progress_projects": 7
   }
   
   # 修改后
   return jsonify({
       "total_projects": 12,
       "total_budget": 1500000.00,
       "completed_projects": 5,
       "in_progress_projects": 7
   })
   ```

## 测试方法

### 1. 测试服务器

```bash
cd server
python app.py
```

服务器应该能够正常启动，没有错误。

### 2. 测试客户端

```bash
cd client
python main.py
```

客户端应该能够正常启动，业财看板和预警中心会显示简化的图表（文本标签）。

## 后续优化建议

### 1. 客户端优化

1. **安装WebEngine组件**：为了获得更好的图表体验，建议安装PyQt6-WebEngine组件。

2. **使用matplotlib替代plotly**：matplotlib可以直接生成图像，不需要WebEngine组件。

3. **添加加载状态指示器**：在数据加载过程中显示加载动画，提升用户体验。

### 2. 服务器端优化

1. **统一API设计风格**：确保所有API端点遵循相同的设计风格和命名约定。

2. **添加错误处理中间件**：实现统一的错误处理机制，提供友好的错误信息。

3. **实现数据库连接池**：优化数据库连接管理，提高性能。

4. **添加API文档**：使用Swagger或其他工具生成API文档，便于开发和维护。

## 总结

通过以上修复，系统的两个主要错误已经解决：

1. 客户端错误通过替代WebEngine组件解决，使用简单的QLabel显示图表信息。

2. 服务器端错误通过将API端点从FastAPI风格转换为Flask蓝图风格解决。

这些修复使系统能够正常启动和运行，但为了获得更好的用户体验和系统性能，建议按照后续优化建议进行进一步改进。
