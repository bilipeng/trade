# 业财看板和预警中心功能实现指南

本文档详细说明了如何实现业财看板和预警中心的功能，包括数据可视化、图表展示和预警规则编辑功能。

## 一、业财看板功能实现

### 1. 功能概述

业财看板主要实现以下功能：

- 项目统计数据展示（总项目数、总预算、已完成项目、进行中项目）
- 项目进度数据可视化（表格和图表展示）
- 预算执行数据可视化（表格和图表展示）
- 数据自动刷新和手动刷新

### 2. 实现步骤

#### 2.1 导入必要的库

```python
from PyQt6.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, QLabel,
                           QTableWidget, QTableWidgetItem, QProgressBar, 
                           QPushButton, QTabWidget, QFrame, QSplitter)
from PyQt6.QtCore import Qt, QSize
from PyQt6.QtGui import QColor
import requests
import json
from datetime import datetime
import matplotlib.pyplot as plt
from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg as FigureCanvas
from matplotlib.figure import Figure
```

#### 2.2 创建UI界面

UI界面包括以下部分：

1. **顶部工具栏**：包含刷新按钮
2. **项目统计区域**：显示关键统计数据
3. **选项卡界面**：
   - 项目进度选项卡：包含表格和图表
   - 预算执行选项卡：包含表格和图表

#### 2.3 数据加载和处理

数据加载函数从后端API获取数据，并处理可能的错误：

```python
def loadData(self):
    """加载数据"""
    try:
        # 从主窗口获取token
        token = self.parent().token if self.parent() and hasattr(self.parent(), 'token') else None
        headers = {"Authorization": f"Bearer {token}"} if token else {}
        
        # 加载项目统计数据
        try:
            response = requests.get(
                "http://localhost:8000/api/projects/stats",
                headers=headers
            )
            # 处理响应...
        except Exception as e:
            # 使用模拟数据...
            
        # 加载项目进度数据
        # 加载预算执行数据
        # ...
    except Exception as e:
        print(f"加载数据失败: {str(e)}")
        import traceback
        traceback.print_exc()
```

#### 2.4 数据可视化实现

1. **表格可视化**：
   - 使用QTableWidget显示数据
   - 根据数据设置单元格颜色（如进度落后显示红色）
   - 格式化数字（如金额显示千分位）

2. **图表可视化**：
   - 使用Matplotlib创建柱状图
   - 设置图表标题、轴标签和图例
   - 添加数据标签
   - 使用FigureCanvas将图表嵌入到PyQt界面

### 3. 关键代码说明

#### 3.1 创建进度图表

```python
def createProgressChart(self, data):
    """创建项目进度图表"""
    # 清除之前的图表
    self.progress_figure.clear()
    
    # 创建子图
    ax = self.progress_figure.add_subplot(111)
    
    # 设置数据
    names = data["names"]
    planned = data["planned_progress"]
    actual = data["actual_progress"]
    
    # 设置柱状图位置
    x = range(len(names))
    width = 0.35
    
    # 绘制柱状图
    ax.bar([i - width/2 for i in x], planned, width, label='计划进度', color='#4285F4')
    ax.bar([i + width/2 for i in x], actual, width, label='实际进度', color='#34A853')
    
    # 设置图表属性
    ax.set_ylabel('进度 (%)')
    ax.set_title('项目进度对比')
    ax.set_xticks(x)
    ax.set_xticklabels(names)
    ax.legend()
    
    # 添加数据标签
    for i, v in enumerate(planned):
        ax.text(i - width/2, v + 2, str(v), ha='center', va='bottom')
    for i, v in enumerate(actual):
        ax.text(i + width/2, v + 2, str(v), ha='center', va='bottom')
    
    # 刷新画布
    self.progress_canvas.draw()
```

#### 3.2 更新预算表格

```python
def updateBudgetTable(self, data):
    """更新预算表格"""
    self.budget_table.setRowCount(len(data["names"]))
    for i, name in enumerate(data["names"]):
        # 项目名称
        name_item = QTableWidgetItem(name)
        self.budget_table.setItem(i, 0, name_item)
        
        # 预算金额
        budget = data['budget'][i]
        budget_item = QTableWidgetItem(f"¥{budget:,.2f}")
        self.budget_table.setItem(i, 1, budget_item)
        
        # 已用金额
        spent = data['spent'][i]
        spent_item = QTableWidgetItem(f"¥{spent:,.2f}")
        
        # 根据预算使用情况设置颜色
        if spent > budget * 1.1:  # 超出预算10%以上
            spent_item.setBackground(QColor(255, 200, 200))  # 浅红色
        elif spent > budget:  # 略微超出预算
            spent_item.setBackground(QColor(255, 235, 200))  # 浅橙色
        elif spent < budget * 0.5:  # 使用不足50%
            spent_item.setBackground(QColor(200, 235, 255))  # 浅蓝色
        
        self.budget_table.setItem(i, 2, spent_item)
    
    # 调整列宽
    self.budget_table.resizeColumnsToContents()
```

## 二、预警中心功能实现

### 1. 功能概述

预警中心主要实现以下功能：

- 资金池监控（总资金和部门资金使用情况）
- 预警规则管理（添加、编辑、删除规则）
- 预警记录查看和处理

### 2. 实现步骤

#### 2.1 编辑规则功能实现

编辑规则功能允许用户修改现有的预警规则：

```python
def editRule(self, rule_id):
    """编辑规则"""
    try:
        # 从规则列表中找到对应ID的规则
        rule_data = None
        for i in range(self.rules_table.rowCount()):
            if self.rules_table.item(i, 0) and self.rules_table.item(i, 0).text():
                # 假设规则ID存储在表格的隐藏数据中
                if i == rule_id - 1:  # 简化处理，假设ID是连续的
                    rule_data = {
                        'id': rule_id,
                        'name': self.rules_table.item(i, 0).text(),
                        'indicator': self.rules_table.item(i, 1).text(),
                        'condition': self.rules_table.item(i, 2).text(),
                        'threshold': float(self.rules_table.item(i, 3).text()),
                        'severity': self.rules_table.item(i, 4).text(),
                        'is_active': self.rules_table.item(i, 5).text() == "启用"
                    }
                    break
        
        if not rule_data:
            QMessageBox.warning(self, "错误", f"找不到ID为{rule_id}的规则")
            return
            
        # 创建编辑对话框
        dialog = AlertRuleDialog(self)
        
        # 填充现有数据
        dialog.name_edit.setText(rule_data['name'])
        dialog.desc_edit.setText(f"编辑规则 {rule_data['name']}")
        
        # 设置下拉框选项
        indicator_index = dialog.indicator_combo.findText(rule_data['indicator'])
        if indicator_index >= 0:
            dialog.indicator_combo.setCurrentIndex(indicator_index)
            
        condition_index = dialog.condition_combo.findText(rule_data['condition'])
        if condition_index >= 0:
            dialog.condition_combo.setCurrentIndex(condition_index)
            
        dialog.threshold_spin.setValue(rule_data['threshold'])
        
        severity_index = dialog.severity_combo.findText(rule_data['severity'])
        if severity_index >= 0:
            dialog.severity_combo.setCurrentIndex(severity_index)
        
        # 显示对话框
        if dialog.exec() == QDialog.DialogCode.Accepted:
            # 刷新数据
            self.loadData()
            QMessageBox.information(self, "成功", "规则更新成功")
    
    except Exception as e:
        print(f"编辑规则失败: {str(e)}")
        import traceback
        traceback.print_exc()
        QMessageBox.warning(self, "错误", f"编辑规则失败: {str(e)}")
```

### 3. 关键代码说明

#### 3.1 预警规则对话框

预警规则对话框用于添加和编辑预警规则：

```python
class AlertRuleDialog(QDialog):
    """预警规则配置对话框"""

    def __init__(self, parent=None):
        super().__init__(parent)
        self.api_base = "http://localhost:8000"
        self.initUI()

    def initUI(self):
        """初始化界面"""
        self.setWindowTitle("预警规则配置")
        layout = QFormLayout()

        # 规则名称
        self.name_edit = QLineEdit()
        layout.addRow("规则名称:", self.name_edit)

        # 规则描述
        self.desc_edit = QLineEdit()
        layout.addRow("规则描述:", self.desc_edit)

        # 监控指标
        self.indicator_combo = QComboBox()
        self.indicator_combo.addItems([
            "资金使用率", "预算超支", "进度延迟", "回款逾期"
        ])
        layout.addRow("监控指标:", self.indicator_combo)

        # 条件
        self.condition_combo = QComboBox()
        self.condition_combo.addItems([
            "大于", "小于", "等于"
        ])
        layout.addRow("条件:", self.condition_combo)

        # 阈值
        self.threshold_spin = QDoubleSpinBox()
        self.threshold_spin.setRange(0, 1000)
        self.threshold_spin.setValue(80)
        layout.addRow("阈值:", self.threshold_spin)

        # 严重程度
        self.severity_combo = QComboBox()
        self.severity_combo.addItems([
            "低", "中", "高"
        ])
        layout.addRow("严重程度:", self.severity_combo)

        # 通知角色
        self.roles_combo = QComboBox()
        self.roles_combo.addItems([
            "项目经理", "财务主管", "部门经理"
        ])
        layout.addRow("通知角色:", self.roles_combo)

        # 按钮
        btn_layout = QHBoxLayout()
        save_btn = QPushButton("保存")
        save_btn.clicked.connect(self.saveRule)
        cancel_btn = QPushButton("取消")
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(save_btn)
        btn_layout.addWidget(cancel_btn)
        layout.addRow("", btn_layout)

        self.setLayout(layout)
```

## 三、测试和调试

### 1. 测试方法

1. **单元测试**：测试各个功能模块是否正常工作
2. **集成测试**：测试整个系统的交互是否正常
3. **用户界面测试**：测试UI是否友好，是否有布局问题

### 2. 调试技巧

1. **打印日志**：在关键位置添加print语句，输出变量值和执行流程
2. **异常捕获**：使用try-except捕获异常，并打印详细的错误信息
3. **模拟数据**：当API不可用时，使用模拟数据进行测试

## 四、注意事项

1. **错误处理**：所有网络请求和数据处理都应该有适当的错误处理
2. **性能优化**：避免在UI线程中进行耗时操作，考虑使用多线程
3. **用户体验**：提供适当的反馈，如加载指示器、错误提示等
4. **代码可维护性**：使用清晰的命名和注释，遵循代码规范

## 五、后续改进

1. **数据缓存**：实现数据缓存，减少API请求
2. **实时更新**：实现WebSocket连接，获取实时数据更新
3. **更丰富的图表**：添加更多类型的图表，如饼图、折线图等
4. **导出功能**：允许用户导出数据和图表
5. **自定义视图**：允许用户自定义看板布局和内容
